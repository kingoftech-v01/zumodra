{% extends 'base/freelanhub_dashboard_base.html' %}
{% load static i18n %}

{% block dashboard_content %}
<!-- Breadcrumb -->
<div class="flex items-center gap-2 mb-6">
    <a href="{% url 'frontend:dashboard' %}" class="caption1 text-secondary hover:text-primary">
        <span class="ph ph-house"></span>
    </a>
    <span class="ph ph-caret-right text-secondary"></span>
    <span class="caption1 text-title">{% trans "Messages" %}</span>
</div>

<!-- Tenant Type Badge -->
{% if request.tenant %}
    {% if request.tenant.tenant_type == 'company' %}
        <span class="tag bg-blue text-white px-3 py-1.5 rounded-lg inline-flex items-center gap-2 mb-6">
            <span class="ph ph-buildings"></span>
            {% trans "Company" %}
        </span>
    {% else %}
        <span class="tag bg-green text-white px-3 py-1.5 rounded-lg inline-flex items-center gap-2 mb-6">
            <span class="ph ph-user-circle"></span>
            {% trans "Freelancer" %}
        </span>
    {% endif %}
{% endif %}

<!-- Header -->
<div class="flex items-center justify-between mb-8">
    <div>
        <h3 class="heading3 mb-2">{% trans "Messages" %}</h3>
        <p class="caption1 text-secondary">{% trans "Manage your conversations" %}</p>
    </div>
    <button class="button-main" data-bs-toggle="modal" data-bs-target="#newConversationModal">
        <span class="ph ph-pencil-simple"></span>
        {% trans "New Message" %}
    </button>
</div>

<!-- Messages Container -->
<div class="p-7.5 rounded-2xl bg-white">
    <!-- Tabs -->
    <div class="flex items-center gap-4 border-b border-line pb-4 mb-6">
        <a href="{% url 'frontend:messages:conversations' %}"
           class="text-button {% if not filter %}text-primary{% else %}text-secondary hover:text-title{% endif %}">
            {% trans "All" %} <span class="tag -small bg-surface text-secondary ml-2">{{ total_count }}</span>
        </a>
        <a href="?filter=unread"
           class="text-button {% if filter == 'unread' %}text-primary{% else %}text-secondary hover:text-title{% endif %}">
            {% trans "Unread" %} <span class="tag -small bg-primary text-white ml-2">{{ unread_count }}</span>
        </a>
        <a href="?filter=archived"
           class="text-button {% if filter == 'archived' %}text-primary{% else %}text-secondary hover:text-title{% endif %}">
            {% trans "Archived" %}
        </a>
    </div>

    <!-- Conversations List -->
    <div class="space-y-3">
        {% for conversation in conversations %}
        <a href="{% url 'frontend:messages:chat' conversation.id %}"
           class="flex items-center gap-4 p-4 rounded-lg hover:bg-surface transition-colors">
            <div class="relative flex-shrink-0">
                <div class="w-12 h-12 rounded-full bg-surface flex items-center justify-center">
                    <span class="ph ph-user text-2xl text-secondary"></span>
                </div>
                {% if conversation.unread_count %}
                <span class="absolute -top-1 -right-1 w-5 h-5 bg-red rounded-full flex items-center justify-center caption2 text-white">
                    {{ conversation.unread_count }}
                </span>
                {% endif %}
            </div>
            <div class="flex-1 min-w-0">
                <div class="flex items-center justify-between mb-1">
                    <h6 class="text-button text-title {% if conversation.unread_count %}font-bold{% endif %}">
                        {{ conversation.name|default:"Conversation" }}
                    </h6>
                    <span class="caption2 text-secondary">{{ conversation.updated_at|timesince }} {% trans "ago" %}</span>
                </div>
                <p class="caption1 text-secondary truncate">
                    {{ conversation.last_message.content|default:"No messages" }}
                </p>
                <div class="caption2 text-secondary mt-1">
                    {% for p in conversation.participants.all|slice:":3" %}
                    {{ p.get_full_name|default:p.email }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                    {% if conversation.participants.count > 3 %}
                    {% trans "and" %} {{ conversation.participants.count|add:"-3" }} {% trans "more" %}
                    {% endif %}
                </div>
            </div>
        </a>
        {% empty %}
        <div class="text-center py-16">
            <span class="ph ph-chat-circle text-[80px] text-secondary mb-4 block"></span>
            <h5 class="heading5 mb-2">{% trans "No conversations" %}</h5>
            <p class="caption1 text-secondary mb-6">{% trans "Start a new conversation to get started" %}</p>
            <button class="button-main" data-bs-toggle="modal" data-bs-target="#newConversationModal">
                <span class="ph ph-pencil-simple"></span>
                {% trans "New Message" %}
            </button>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if conversations.has_other_pages %}
    <div class="flex items-center justify-center gap-3 mt-8 pt-6 border-t border-line">
        {% if conversations.has_previous %}
        <a href="?page={{ conversations.previous_page_number }}" class="button-main -outline -small">
            <span class="ph ph-caret-left"></span>
            {% trans "Previous" %}
        </a>
        {% endif %}
        <span class="caption1 text-secondary">
            {% trans "Page" %} {{ conversations.number }} {% trans "of" %} {{ conversations.paginator.num_pages }}
        </span>
        {% if conversations.has_next %}
        <a href="?page={{ conversations.next_page_number }}" class="button-main -outline -small">
            {% trans "Next" %}
            <span class="ph ph-caret-right"></span>
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- New Conversation Modal -->
<div class="zu-modal fade" id="newConversationModal" tabindex="-1">
    <div class="zu-modal__dialog">
        <div class="zu-modal__content">
            <div class="zu-modal__header border-b border-line">
                <h5 class="zu-modal__title heading5">{% trans "New Conversation" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'frontend:messages:new_conversation' %}">
                {% csrf_token %}
                <div class="zu-modal__body">
                    <div class="zu-form-group mb-4">
                        <label class="caption1 text-title mb-2 block">{% trans "To" %}</label>
                        <select name="recipients" class="w-full h-12 px-4 border border-line rounded-lg" multiple required>
                            {% for contact in contacts %}
                            <option value="{{ contact.id }}">{{ contact.get_full_name|default:contact.email }}</option>
                            {% endfor %}
                        </select>
                        <span class="caption2 text-secondary mt-1 block">{% trans "Hold Ctrl/Cmd to select multiple recipients" %}</span>
                    </div>
                    <div class="zu-form-group mb-4">
                        <label class="caption1 text-title mb-2 block">{% trans "Subject" %}</label>
                        <input type="text" name="title" class="w-full h-12 px-4 border border-line rounded-lg" placeholder="{% trans 'Optional' %}">
                    </div>
                    <div class="zu-form-group mb-4">
                        <label class="caption1 text-title mb-2 block">{% trans "Message" %}</label>
                        <textarea name="content" class="w-full px-4 py-3 border border-line rounded-lg" rows="4" required></textarea>
                    </div>
                </div>
                <div class="zu-modal__footer border-t border-line">
                    <button type="button" class="button-main -outline" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                    <button type="submit" class="button-main">
                        <span class="ph ph-paper-plane-right"></span>
                        {% trans "Send" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
