{% extends 'base/freelanhub_dashboard_base.html' %}
{% load static i18n %}

{% block dashboard_content %}
<!-- Breadcrumb -->
<div class="flex items-center gap-2 mb-6">
    <a href="{% url 'frontend:dashboard' %}" class="caption1 text-secondary hover:text-primary">
        <span class="ph ph-house"></span>
    </a>
    <span class="ph ph-caret-right text-secondary"></span>
    <a href="{% url 'frontend:messages:conversations' %}" class="caption1 text-secondary hover:text-primary">
        {% trans "Messages" %}
    </a>
    <span class="ph ph-caret-right text-secondary"></span>
    <span class="caption1 text-title">{{ conversation.name|default:"Chat"|truncatewords:3 }}</span>
</div>

<!-- Tenant Type Badge -->
{% if request.tenant %}
    {% if request.tenant.tenant_type == 'company' %}
        <span class="tag bg-blue text-white px-3 py-1.5 rounded-lg inline-flex items-center gap-2 mb-6">
            <span class="ph ph-buildings"></span>
            {% trans "Company" %}
        </span>
    {% else %}
        <span class="tag bg-green text-white px-3 py-1.5 rounded-lg inline-flex items-center gap-2 mb-6">
            <span class="ph ph-user-circle"></span>
            {% trans "Freelancer" %}
        </span>
    {% endif %}
{% endif %}

<!-- Messages Container with Split View -->
<div class="flex gap-6 h-[calc(100vh-250px)]">
    <!-- Conversations List Sidebar -->
    <div class="w-[320px] flex-shrink-0 p-6 rounded-2xl bg-white">
        <div class="flex items-center justify-between mb-6">
            <h4 class="heading5">{% trans "Messages" %}</h4>
            <button class="button-main -icon -small" data-bs-toggle="modal" data-bs-target="#newConversationModal">
                <span class="ph ph-pencil-simple"></span>
            </button>
        </div>

        <!-- Search (Optional) -->
        <div class="mb-4">
            <div class="relative">
                <input type="text" placeholder="{% trans 'Search...' %}" class="w-full h-10 pl-10 pr-3 border border-line rounded-lg caption1">
                <span class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-secondary"></span>
            </div>
        </div>

        <!-- Conversation Items -->
        <div class="space-y-2 overflow-y-auto" style="max-height: calc(100% - 150px);">
            {% for conv in conversations %}
            <a href="{% url 'frontend:messages:chat' conv.id %}"
               class="flex items-start gap-3 p-3 rounded-lg transition-colors {% if conv == conversation %}bg-surface{% else %}hover:bg-surface{% endif %}">
                <div class="relative flex-shrink-0">
                    <div class="w-10 h-10 rounded-full bg-surface flex items-center justify-center">
                        <span class="ph ph-user text-xl text-secondary"></span>
                    </div>
                    {% if conv.unread_count %}
                    <span class="absolute bottom-0 right-0 w-3 h-3 bg-green rounded-full border-2 border-white"></span>
                    {% endif %}
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-button text-title">{{ conv.name|default:"Conversation"|truncatewords:3 }}</span>
                        <span class="caption2 text-secondary">{{ conv.updated_at|timesince|truncatewords:1 }}</span>
                    </div>
                    <p class="caption1 text-secondary truncate">{{ conv.last_message.content|default:"No messages yet" }}</p>
                </div>
            </a>
            {% empty %}
            <div class="text-center py-8">
                <span class="ph ph-chat-circle text-[40px] text-secondary mb-2 block"></span>
                <p class="caption2 text-secondary">{% trans "No conversations yet" %}</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Chat View -->
    {% if conversation %}
    <div class="flex-1 p-8 rounded-2xl bg-white flex flex-col">
        <!-- Chat Header -->
        <div class="flex items-center justify-between pb-4 border-b border-line mb-6">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-surface flex items-center justify-center">
                    <span class="ph ph-user text-xl text-secondary"></span>
                </div>
                <div>
                    <h5 class="heading6">{{ conversation.name|default:"Conversation" }}</h5>
                    <div class="caption2 text-secondary">
                        {% for participant in conversation.participants.all %}
                        {{ participant.get_full_name|default:participant.email }}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="relative" x-data="{ open: false }">
                <button @click="open = !open" class="button-main -icon -outline">
                    <span class="ph ph-dots-three-vertical"></span>
                </button>
                <div x-show="open" @click.away="open = false" x-transition
                     class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-line z-10">
                    <a href="#" id="archiveConversation" class="block px-4 py-2 caption1 text-secondary hover:bg-surface">
                        {% trans "Archive" %}
                    </a>
                    <a href="#" id="deleteConversation" class="block px-4 py-2 caption1 text-red hover:bg-surface">
                        {% trans "Delete" %}
                    </a>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div id="messagesContainer" class="flex-1 overflow-y-auto space-y-4 mb-6">
            {% for message in messages %}
            <div class="flex {% if message.sender == request.user %}justify-end{% endif %}">
                <div class="max-w-[70%] p-4 rounded-lg {% if message.sender == request.user %}bg-primary text-white{% else %}bg-surface{% endif %}">
                    <p class="caption1">{{ message.content }}</p>
                    <div class="flex items-center gap-2 mt-2">
                        <span class="caption2 {% if message.sender == request.user %}text-white opacity-70{% else %}text-secondary{% endif %}">
                            {{ message.sender.get_full_name|default:message.sender.email }} &middot; {{ message.timestamp|time:"g:i A" }}
                        </span>
                        {% if message.is_read and message.sender == request.user %}
                        <span class="ph ph-checks {% if message.sender == request.user %}text-white{% endif %}"></span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-16">
                <span class="ph ph-chat-circle-text text-[80px] text-secondary mb-4 block"></span>
                <h5 class="heading5 mb-2">{% trans "No messages yet" %}</h5>
                <p class="caption1 text-secondary">{% trans "Start the conversation!" %}</p>
            </div>
            {% endfor %}
        </div>

        <!-- Message Input -->
        <form id="messageForm" method="post" action="{% url 'frontend:messages:send_message' conversation.id %}" class="flex items-center gap-3">
            {% csrf_token %}
            <input type="text" name="content" placeholder="{% trans 'Type a message...' %}" autocomplete="off" required
                   class="flex-1 h-12 px-4 border border-line rounded-lg caption1">
            <button type="button" id="attachmentBtn" class="button-main -icon -outline">
                <span class="ph ph-paperclip"></span>
            </button>
            <button type="submit" class="button-main">
                <span class="ph ph-paper-plane-right"></span>
                {% trans "Send" %}
            </button>
        </form>
    </div>
    {% else %}
    <!-- No Conversation Selected -->
    <div class="flex-1 p-8 rounded-2xl bg-white flex items-center justify-center">
        <div class="text-center">
            <span class="ph ph-chat-circle-text text-[120px] text-secondary mb-6 block"></span>
            <h5 class="heading4 mb-2">{% trans "Select a conversation" %}</h5>
            <p class="caption1 text-secondary mb-6">{% trans "Choose a conversation from the sidebar or start a new one" %}</p>
            <button class="button-main" data-bs-toggle="modal" data-bs-target="#newConversationModal">
                <span class="ph ph-pencil-simple"></span>
                {% trans "Start New Conversation" %}
            </button>
        </div>
    </div>
    {% endif %}
</div>

<!-- New Conversation Modal -->
<div class="zu-modal fade" id="newConversationModal" tabindex="-1">
    <div class="zu-modal__dialog">
        <div class="zu-modal__content">
            <div class="zu-modal__header border-b border-line">
                <h5 class="zu-modal__title heading5">{% trans "New Conversation" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'frontend:messages:new_conversation' %}">
                {% csrf_token %}
                <div class="zu-modal__body">
                    <div class="zu-form-group mb-4">
                        <label class="caption1 text-title mb-2 block">{% trans "Recipients" %}</label>
                        <select name="recipients" class="w-full h-12 px-4 border border-line rounded-lg" multiple required>
                            {% for contact in contacts %}
                            <option value="{{ contact.id }}">{{ contact.get_full_name|default:contact.email }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="zu-form-group mb-4">
                        <label class="caption1 text-title mb-2 block">{% trans "Subject (optional)" %}</label>
                        <input type="text" name="title" class="w-full h-12 px-4 border border-line rounded-lg">
                    </div>
                    <div class="zu-form-group mb-4">
                        <label class="caption1 text-title mb-2 block">{% trans "Message" %}</label>
                        <textarea name="content" class="w-full px-4 py-3 border border-line rounded-lg" rows="3" required></textarea>
                    </div>
                </div>
                <div class="zu-modal__footer border-t border-line">
                    <button type="button" class="button-main -outline" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                    <button type="submit" class="button-main">
                        <span class="ph ph-paper-plane-right"></span>
                        {% trans "Start Conversation" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-scroll to bottom of messages
const messagesContainer = document.getElementById('messagesContainer');
if (messagesContainer) {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// WebSocket connection for real-time messages
{% if conversation %}
const conversationId = '{{ conversation.id }}';
{% if websocket_enabled %}
const wsUrl = '{{ websocket_url }}';
{% endif %}
let socket = null;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;
const reconnectDelay = 3000;

function connectWebSocket() {
    {% if not websocket_enabled %}
    console.log('WebSocket disabled, using polling fallback');
    startPolling();
    return;
    {% endif %}

    console.log('Connecting to WebSocket:', wsUrl);
    socket = new WebSocket(wsUrl);

    socket.onopen = function(e) {
        console.log('WebSocket connected');
        reconnectAttempts = 0;
        updateConnectionStatus('online');
    };

    socket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        console.log('Received:', data);

        if (data.type === 'message') {
            displayMessage(data);
        } else if (data.type === 'typing') {
            showTypingIndicator(data.typing_user, data.is_typing);
        } else if (data.type === 'read') {
            updateReadReceipt(data.message_id, data.user);
        } else if (data.type === 'status') {
            console.log('Status:', data.message);
        }
    };

    socket.onerror = function(error) {
        console.error('WebSocket error:', error);
        updateConnectionStatus('error');
    };

    socket.onclose = function(event) {
        console.log('WebSocket closed:', event.code, event.reason);
        updateConnectionStatus('offline');

        // Attempt to reconnect
        if (reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            console.log(`Reconnecting... Attempt ${reconnectAttempts}/${maxReconnectAttempts}`);
            setTimeout(connectWebSocket, reconnectDelay);
        } else {
            console.log('Max reconnect attempts reached, falling back to polling');
            startPolling();
        }
    };
}

function sendMessage(content, fileData = null) {
    const messageData = {
        type: 'send_message',
        content: content
    };

    if (fileData) {
        messageData.file = fileData;
    }

    if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify(messageData));
    } else {
        // Fallback to HTTP POST
        sendMessageHTTP(content, fileData);
    }
}

function sendTypingIndicator(isTyping) {
    if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
            type: 'typing',
            is_typing: isTyping
        }));
    }
}

function sendReadReceipt(messageId) {
    if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
            type: 'read',
            message_id: messageId
        }));
    }
}

function displayMessage(data) {
    const isSentByCurrentUser = data.sender === '{{ request.user.username }}';
    const messageHtml = `
        <div class="flex ${isSentByCurrentUser ? 'justify-end' : ''}">
            <div class="max-w-[70%] p-4 rounded-lg ${isSentByCurrentUser ? 'bg-primary text-white' : 'bg-surface'}">
                <p class="caption1">${escapeHtml(data.content)}</p>
                ${data.file ? `<a href="${data.file}" class="block mt-2 underline">ðŸ“Ž File</a>` : ''}
                <div class="flex items-center gap-2 mt-2">
                    <span class="caption2 ${isSentByCurrentUser ? 'text-white opacity-70' : 'text-secondary'}">
                        ${data.sender} &middot; ${formatTime(data.timestamp)}
                    </span>
                    ${data.is_read && isSentByCurrentUser ? '<span class="ph ph-checks"></span>' : ''}
                </div>
            </div>
        </div>
    `;

    messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showTypingIndicator(user, isTyping) {
    const indicatorId = 'typing-indicator';
    const existingIndicator = document.getElementById(indicatorId);

    if (isTyping && !existingIndicator) {
        const indicatorHtml = `
            <div id="${indicatorId}" class="flex">
                <div class="max-w-[70%] p-4 rounded-lg bg-surface">
                    <p class="caption1 text-secondary">${escapeHtml(user)} is typing...</p>
                </div>
            </div>
        `;
        messagesContainer.insertAdjacentHTML('beforeend', indicatorHtml);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    } else if (!isTyping && existingIndicator) {
        existingIndicator.remove();
    }
}

function updateReadReceipt(messageId, user) {
    console.log(`Message ${messageId} read by ${user}`);
    // Update UI to show read receipt
}

function updateConnectionStatus(status) {
    // Could add a status indicator in the UI
    console.log('Connection status:', status);
}

function sendMessageHTTP(content, fileData) {
    // Fallback to traditional form submission
    const form = document.getElementById('messageForm');
    if (form) {
        form.submit();
    }
}

function startPolling() {
    // Poll for new messages every 3 seconds as fallback
    setInterval(() => {
        location.reload();
    }, 3000);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
}

// Initialize WebSocket connection
connectWebSocket();

// Handle form submission via WebSocket
const messageForm = document.getElementById('messageForm');
if (messageForm) {
    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const input = this.querySelector('input[name="content"]');
        const content = input.value.trim();

        if (content) {
            sendMessage(content);
            input.value = '';
        }
    });

    // Typing indicator
    let typingTimeout;
    const contentInput = messageForm.querySelector('input[name="content"]');
    if (contentInput) {
        contentInput.addEventListener('input', function() {
            sendTypingIndicator(true);
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                sendTypingIndicator(false);
            }, 1000);
        });
    }
}
{% endif %}
</script>
{% endblock %}
