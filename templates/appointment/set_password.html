{% extends 'base/unified_base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Set Your Password" %}{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-5">
            <div class="zu-card shadow-sm">
                <div class="zu-card__header text-center">
                    <h4 class="mb-0">{% trans "Welcome!" %}</h4>
                </div>
                <div class="zu-card__body">
                    <p class="text-muted mb-4 text-center">
                        {% trans "Set a password to access your appointments and manage your bookings." %}
                    </p>

                    {% if error %}
                    <div class="alert alert-danger" role="alert">
                        {{ error }}
                    </div>
                    {% endif %}

                    <form method="post">
                        {% csrf_token %}

                        <div class="zu-form-group mb-3">
                            <label class="zu-label">{% trans "New Password" %} <span class="text-danger">*</span></label>
                            <input type="password"
                                   name="password"
                                   id="password"
                                   class="zu-input"
                                   minlength="8"
                                   required
                                   autofocus>
                            <small class="form-text text-muted">
                                {% trans "Minimum 8 characters" %}
                            </small>
                        </div>

                        <div class="zu-form-group mb-4">
                            <label class="zu-label">{% trans "Confirm Password" %} <span class="text-danger">*</span></label>
                            <input type="password"
                                   name="password_confirm"
                                   id="password_confirm"
                                   class="zu-input"
                                   minlength="8"
                                   required>
                        </div>

                        <!-- Password Strength Indicator -->
                        <div class="mb-4">
                            <div class="progress" style="height: 5px;">
                                <div id="passwordStrength" class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small id="strengthText" class="form-text text-muted"></small>
                        </div>

                        <button type="submit" class="zu-btn zu-btn--primary w-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="me-2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                            </svg>
                            {% trans "Set Password & Continue" %}
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const passwordInput = document.getElementById('password');
const confirmInput = document.getElementById('password_confirm');
const strengthBar = document.getElementById('passwordStrength');
const strengthText = document.getElementById('strengthText');

passwordInput.addEventListener('input', function() {
    const password = this.value;
    let strength = 0;
    let strengthLabel = '';
    let strengthColor = '';

    if (password.length >= 8) strength++;
    if (password.length >= 12) strength++;
    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
    if (/[0-9]/.test(password)) strength++;
    if (/[^a-zA-Z0-9]/.test(password)) strength++;

    switch(strength) {
        case 0:
        case 1:
            strengthLabel = '{% trans "Weak" %}';
            strengthColor = 'bg-danger';
            break;
        case 2:
        case 3:
            strengthLabel = '{% trans "Fair" %}';
            strengthColor = 'bg-warning';
            break;
        case 4:
            strengthLabel = '{% trans "Good" %}';
            strengthColor = 'bg-info';
            break;
        case 5:
            strengthLabel = '{% trans "Strong" %}';
            strengthColor = 'bg-success';
            break;
    }

    strengthBar.className = `progress-bar ${strengthColor}`;
    strengthBar.style.width = `${(strength / 5) * 100}%`;
    strengthText.textContent = `{% trans "Password strength:" %} ${strengthLabel}`;
});

// Password matching validation
document.querySelector('form').addEventListener('submit', function(e) {
    if (passwordInput.value !== confirmInput.value) {
        e.preventDefault();
        alert('{% trans "Passwords do not match. Please try again." %}');
        confirmInput.focus();
    }
});
</script>
{% endblock %}
