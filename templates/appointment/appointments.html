{% extends 'base/unified_base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Book Appointment" %} - {{ service.name }}{% endblock %}

{% block extra_css %}
<style>
.time-slot {
    transition: all 0.2s ease;
}
.time-slot:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.time-slot.selected {
    background-color: #0066cc;
    color: white;
    border-color: #0066cc;
}
.booking-progress {
    counter-reset: step;
}
.booking-progress li {
    list-style: none;
    display: inline-block;
    width: 30%;
    position: relative;
    text-align: center;
    cursor: pointer;
}
.booking-progress li:before {
    content: counter(step);
    counter-increment: step;
    width: 30px;
    height: 30px;
    line-height: 30px;
    border: 2px solid #ddd;
    display: block;
    text-align: center;
    margin: 0 auto 10px;
    border-radius: 50%;
    background-color: white;
}
.booking-progress li.active:before {
    border-color: #0066cc;
    background-color: #0066cc;
    color: white;
}
.booking-progress li.completed:before {
    border-color: #28a745;
    background-color: #28a745;
    color: white;
}
.booking-progress li:after {
    content: '';
    position: absolute;
    width: 100%;
    height: 2px;
    background-color: #ddd;
    top: 15px;
    left: -50%;
    z-index: -1;
}
.booking-progress li:first-child:after {
    content: none;
}
.booking-progress li.active:after,
.booking-progress li.completed:after {
    background-color: #0066cc;
}
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Progress Indicator -->
            <div class="mb-5">
                <ul class="booking-progress p-0">
                    <li class="active"><small>{% trans "Select Time" %}</small></li>
                    <li><small>{% trans "Your Details" %}</small></li>
                    <li><small>{% trans "Confirmation" %}</small></li>
                </ul>
            </div>

            <!-- Service Information -->
            <div class="zu-card shadow-sm mb-4">
                <div class="zu-card__body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h4 class="mb-2">{{ service.name }}</h4>
                            {% if service.description %}
                            <p class="text-muted mb-0">{{ service.description }}</p>
                            {% endif %}
                        </div>
                        <div class="col-md-4 text-md-end">
                            <div class="d-flex flex-column">
                                <span class="h4 mb-1 text-primary">
                                    {{ service.price }} {{ service.currency|default:"CAD" }}
                                </span>
                                <small class="text-muted">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="me-1">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12 6 12 12 16 14"></polyline>
                                    </svg>
                                    {{ service.duration }} {% trans "minutes" %}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Staff Selection (if multiple staff available) -->
            {% if staff_members|length > 1 %}
            <div class="zu-card shadow-sm mb-4">
                <div class="zu-card__header">
                    <h5 class="mb-0">{% trans "Select Staff Member" %}</h5>
                </div>
                <div class="zu-card__body">
                    <div class="row g-3">
                        {% for staff in staff_members %}
                        <div class="col-md-4">
                            <div class="zu-card h-100 {% if staff.is_selected %}border-primary{% endif %}"
                                 style="cursor: pointer;"
                                 onclick="selectStaff({{ staff.id }})">
                                <div class="zu-card__body text-center">
                                    {% if staff.photo %}
                                    <img src="{{ staff.photo.url }}" class="rounded-circle mb-2" width="80" height="80" alt="{{ staff.user.get_full_name }}">
                                    {% else %}
                                    <div class="bg-secondary rounded-circle d-inline-block mb-2" style="width: 80px; height: 80px;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="text-white" style="margin-top: 20px;">
                                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                            <circle cx="12" cy="7" r="4"></circle>
                                        </svg>
                                    </div>
                                    {% endif %}
                                    <h6 class="mb-1">{{ staff.user.get_full_name }}</h6>
                                    {% if staff.title %}
                                    <small class="text-muted">{{ staff.title }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Date & Time Selection -->
            <div class="zu-card shadow-sm">
                <div class="zu-card__header">
                    <h5 class="mb-0">{% trans "Select Date & Time" %}</h5>
                </div>
                <div class="zu-card__body">
                    <form method="post" id="appointmentForm">
                        {% csrf_token %}

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="zu-label">{% trans "Date" %}</label>
                                <input type="date"
                                       name="date"
                                       id="appointmentDate"
                                       class="zu-input"
                                       min="{{ min_date|date:'Y-m-d' }}"
                                       max="{{ max_date|date:'Y-m-d' }}"
                                       required>
                            </div>
                        </div>

                        <!-- Available Time Slots -->
                        <div id="timeSlotsSection" style="display: none;">
                            <label class="zu-label mb-3">{% trans "Available Times" %}</label>
                            <div id="loadingSlots" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">{% trans "Loading..." %}</span>
                                </div>
                                <p class="text-muted mt-2">{% trans "Finding available slots..." %}</p>
                            </div>
                            <div id="timeSlotsContainer" class="row g-2"></div>
                            <div id="noSlotsMessage" class="alert alert-info" style="display: none;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="me-2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="16" x2="12" y2="12"></line>
                                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                                </svg>
                                {% trans "No available time slots for this date. Please select another date." %}
                            </div>
                        </div>

                        <input type="hidden" name="start_time" id="selectedStartTime">
                        <input type="hidden" name="end_time" id="selectedEndTime">
                        {% if staff_members|length == 1 %}
                        <input type="hidden" name="staff_member_id" value="{{ staff_members.0.id }}">
                        {% else %}
                        <input type="hidden" name="staff_member_id" id="selectedStaffId">
                        {% endif %}

                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'frontend:appointment_customer:service_list' %}" class="zu-btn zu-btn--outline">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="me-1">
                                    <line x1="19" y1="12" x2="5" y2="12"></line>
                                    <polyline points="12 19 5 12 12 5"></polyline>
                                </svg>
                                {% trans "Back" %}
                            </a>
                            <button type="submit" class="zu-btn zu-btn--primary" id="continueBtn" disabled>
                                {% trans "Continue" %}
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="ms-1">
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                    <polyline points="12 5 19 12 12 19"></polyline>
                                </svg>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const dateInput = document.getElementById('appointmentDate');
const timeSlotsSection = document.getElementById('timeSlotsSection');
const loadingSlots = document.getElementById('loadingSlots');
const timeSlotsContainer = document.getElementById('timeSlotsContainer');
const noSlotsMessage = document.getElementById('noSlotsMessage');
const continueBtn = document.getElementById('continueBtn');
let selectedSlot = null;

dateInput.addEventListener('change', function() {
    const date = this.value;
    if (date) {
        loadAvailableSlots(date);
    }
});

function selectStaff(staffId) {
    document.querySelectorAll('.staff-card').forEach(card => {
        card.classList.remove('border-primary');
    });
    event.target.closest('.zu-card').classList.add('border-primary');
    document.getElementById('selectedStaffId').value = staffId;

    // Reload slots if date is already selected
    const date = dateInput.value;
    if (date) {
        loadAvailableSlots(date);
    }
}

function loadAvailableSlots(date) {
    timeSlotsSection.style.display = 'block';
    loadingSlots.style.display = 'block';
    timeSlotsContainer.innerHTML = '';
    noSlotsMessage.style.display = 'none';
    continueBtn.disabled = true;

    const staffId = document.getElementById('selectedStaffId')?.value || '{{ staff_members.0.id }}';
    const serviceId = '{{ service.id }}';

    fetch(`{% url 'frontend:appointment:get_available_slots_ajax' %}?date=${date}&service_id=${serviceId}&staff_member_id=${staffId}`)
        .then(response => response.json())
        .then(data => {
            loadingSlots.style.display = 'none';

            if (data.slots && data.slots.length > 0) {
                data.slots.forEach(slot => {
                    const slotBtn = document.createElement('div');
                    slotBtn.className = 'col-6 col-md-3';
                    slotBtn.innerHTML = `
                        <button type="button"
                                class="zu-btn zu-btn--outline w-100 time-slot"
                                data-start="${slot.start_time}"
                                data-end="${slot.end_time}">
                            ${slot.display_time}
                        </button>
                    `;
                    timeSlotsContainer.appendChild(slotBtn);
                });

                // Add click handlers to time slots
                document.querySelectorAll('.time-slot').forEach(btn => {
                    btn.addEventListener('click', function() {
                        document.querySelectorAll('.time-slot').forEach(b => b.classList.remove('selected'));
                        this.classList.add('selected');
                        document.getElementById('selectedStartTime').value = this.dataset.start;
                        document.getElementById('selectedEndTime').value = this.dataset.end;
                        continueBtn.disabled = false;
                    });
                });
            } else {
                noSlotsMessage.style.display = 'block';
            }
        })
        .catch(error => {
            loadingSlots.style.display = 'none';
            console.error('Error loading slots:', error);
            alert('{% trans "Error loading available time slots. Please try again." %}');
        });
}
</script>
{% endblock %}
