{% extends "base/freelanhub_dashboard_base.html" %}
{% load static i18n humanize %}

{% block page_title %}Co-op & Internship Program{% endblock %}

{% block dashboard_content %}
<!-- Page Header -->
<div class="heading flex items-center justify-between mb-7.5">
    <div>
        <h3 class="heading3">{% trans "Co-op & Internship Program" %}</h3>
        <p class="caption1 text-secondary mt-1">{% trans "Manage your co-op postings, view student applicants, and track placements." %}</p>
    </div>
    <a href="{% url 'hr_core:coop_posting_create' %}"
       class="button-main flex items-center gap-2">
        <span class="ph ph-plus text-lg"></span>
        {% trans "Create Posting" %}
    </a>
</div>

{% if request.tenant.tenant_type != 'company' %}
<div class="p-6 rounded-lg bg-yellow bg-opacity-10 border border-yellow mb-7.5">
    <div class="flex gap-3">
        <span class="ph ph-warning text-yellow text-2xl"></span>
        <div>
            <p class="caption1 text-yellow">
                {% trans "HR features are only available for company tenants." %}
                <a href="{% url 'tenants:tenant_settings' %}" class="font-semibold underline hover:opacity-80">
                    {% trans "Switch to company account" %}
                </a>
            </p>
        </div>
    </div>
</div>
{% else %}
<!-- Stats Overview -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-7.5 mb-7.5">
    <div class="p-6 rounded-lg bg-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="caption1 text-secondary mb-1">{% trans "Active Postings" %}</p>
                <p class="heading4 text-blue">{{ active_postings_count }}</p>
            </div>
            <span class="ph ph-briefcase text-blue text-4xl"></span>
        </div>
    </div>
    <div class="p-6 rounded-lg bg-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="caption1 text-secondary mb-1">{% trans "Total Applicants" %}</p>
                <p class="heading4 text-green">{{ total_applicants_count }}</p>
            </div>
            <span class="ph ph-users text-green text-4xl"></span>
        </div>
    </div>
    <div class="p-6 rounded-lg bg-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="caption1 text-secondary mb-1">{% trans "Current Students" %}</p>
                <p class="heading4 text-purple">{{ current_students_count }}</p>
            </div>
            <span class="ph ph-student text-purple text-4xl"></span>
        </div>
    </div>
    <div class="p-6 rounded-lg bg-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="caption1 text-secondary mb-1">{% trans "Completed Terms" %}</p>
                <p class="heading4 text-emerald">{{ completed_terms_count }}</p>
            </div>
            <span class="ph ph-check-circle text-emerald text-4xl"></span>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-7.5">
    <!-- Active Postings -->
    <div class="lg:col-span-2">
        <div class="p-8 rounded-lg bg-white">
            <div class="flex items-center justify-between mb-6 pb-6 border-b border-line">
                <h4 class="heading5">{% trans "Active Co-op Postings" %}</h4>
                <a href="{% url 'hr_core:coop_postings_list' %}"
                   class="caption1 text-primary hover:underline">
                    {% trans "View All" %}
                </a>
            </div>

            {% if active_postings %}
            <div class="space-y-4">
                {% for posting in active_postings %}
                <div class="p-4 rounded-lg hover:bg-surface transition-colors">
                    <div class="flex items-start justify-between">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <a href="{% url 'hr_core:coop_posting_detail' posting.id %}"
                                   class="caption1 text-title font-semibold hover:text-primary truncate">
                                    {{ posting.title }}
                                </a>
                                <span class="tag
                                    {% if posting.status == 'active' %}bg-green bg-opacity-10 text-green
                                    {% elif posting.status == 'draft' %}bg-yellow bg-opacity-10 text-yellow
                                    {% else %}bg-grey bg-opacity-10 text-grey{% endif %}">
                                    {{ posting.get_status_display }}
                                </span>
                            </div>
                            <div class="mt-1 flex items-center gap-4 caption1 text-secondary">
                                <span class="flex items-center gap-1">
                                    <span class="ph ph-map-pin"></span>
                                    {{ posting.location|default:"Remote" }}
                                </span>
                                <span class="flex items-center gap-1">
                                    <span class="ph ph-calendar"></span>
                                    {{ posting.term_start|date:"M Y" }}
                                </span>
                            </div>
                        </div>
                        <div class="ml-4 flex items-center gap-4">
                            <div class="text-center">
                                <p class="heading6 text-title">{{ posting.applicants_count }}</p>
                                <p class="caption2 text-secondary">{% trans "Applicants" %}</p>
                            </div>
                            <a href="{% url 'hr_core:coop_posting_applicants' posting.id %}"
                               class="text-primary hover:text-opacity-80">
                                <span class="ph ph-caret-right text-xl"></span>
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-12">
                <span class="ph ph-briefcase text-secondary text-6xl mb-4 inline-block"></span>
                <h5 class="heading6 mb-1">{% trans "No active postings" %}</h5>
                <p class="caption1 text-secondary mb-6">{% trans "Create a co-op posting to start receiving applications." %}</p>
                <a href="{% url 'hr_core:coop_posting_create' %}"
                   class="button-main inline-flex items-center gap-2">
                    <span class="ph ph-plus text-lg"></span>
                    {% trans "Create Posting" %}
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Recent Applicants -->
    <div>
        <div class="p-6 rounded-lg bg-white">
            <h5 class="heading6 mb-4 pb-4 border-b border-line">{% trans "Recent Applicants" %}</h5>

            {% if recent_applicants %}
            <ul class="space-y-4">
                {% for applicant in recent_applicants|slice:":5" %}
                <li>
                    <div class="flex items-center gap-3">
                        {% if applicant.student.user.profile.avatar %}
                        <img src="{{ applicant.student.user.profile.avatar.url }}" alt="{{ applicant.student.user.get_full_name }}"
                             class="w-10 h-10 rounded-full object-cover">
                        {% else %}
                        <div class="w-10 h-10 rounded-full bg-primary bg-opacity-10 flex items-center justify-center">
                            <span class="caption1 text-primary font-semibold">
                                {{ applicant.student.user.get_full_name|slice:":1"|upper }}
                            </span>
                        </div>
                        {% endif %}
                        <div class="flex-1 min-w-0">
                            <p class="caption1 text-title truncate font-semibold">
                                {{ applicant.student.user.get_full_name }}
                            </p>
                            <p class="caption2 text-secondary truncate">
                                {{ applicant.student.program_name }}
                            </p>
                        </div>
                        {% if applicant.student.user.trust_score %}
                        {% include "components/trust_badge.html" with trust_score=applicant.student.user.trust_score size="sm" %}
                        {% endif %}
                    </div>
                    <div class="mt-2 flex items-center justify-between">
                        <span class="caption2 text-secondary">
                            {{ applicant.posting.title|truncatewords:3 }}
                        </span>
                        <a href="{% url 'hr_core:coop_applicant_detail' applicant.id %}"
                           class="caption2 text-primary hover:underline">
                            {% trans "View" %}
                        </a>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <div class="text-center py-6">
                <p class="caption1 text-secondary">{% trans "No applicants yet." %}</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Current Students -->
{% if current_students %}
<div class="p-8 rounded-lg bg-white mt-7.5">
    <div class="flex items-center justify-between mb-6 pb-6 border-b border-line">
        <h4 class="heading5">{% trans "Current Students" %}</h4>
        <a href="{% url 'hr_core:coop_current_students' %}"
           class="caption1 text-primary hover:underline">
            {% trans "View All" %}
        </a>
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full">
            <thead class="bg-surface">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left caption2 text-secondary uppercase tracking-wider">
                        {% trans "Student" %}
                    </th>
                    <th scope="col" class="px-6 py-3 text-left caption2 text-secondary uppercase tracking-wider">
                        {% trans "Position" %}
                    </th>
                    <th scope="col" class="px-6 py-3 text-left caption2 text-secondary uppercase tracking-wider">
                        {% trans "Institution" %}
                    </th>
                    <th scope="col" class="px-6 py-3 text-left caption2 text-secondary uppercase tracking-wider">
                        {% trans "Term End" %}
                    </th>
                    <th scope="col" class="px-6 py-3 text-left caption2 text-secondary uppercase tracking-wider">
                        {% trans "Status" %}
                    </th>
                    <th scope="col" class="relative px-6 py-3">
                        <span class="sr-only">{% trans "Actions" %}</span>
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-line">
                {% for term in current_students %}
                <tr class="hover:bg-surface transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center gap-3">
                            {% if term.student.user.profile.avatar %}
                            <img src="{{ term.student.user.profile.avatar.url }}" alt="{{ term.student.user.get_full_name }}"
                                 class="w-8 h-8 rounded-full object-cover">
                            {% else %}
                            <div class="w-8 h-8 rounded-full bg-primary bg-opacity-10 flex items-center justify-center">
                                <span class="caption2 text-primary font-semibold">
                                    {{ term.student.user.get_full_name|slice:":1"|upper }}
                                </span>
                            </div>
                            {% endif %}
                            <div>
                                <p class="caption1 text-title font-semibold">{{ term.student.user.get_full_name }}</p>
                                <p class="caption2 text-secondary">{{ term.student.user.email }}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap caption1 text-title">
                        {{ term.job_title }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap caption1 text-secondary">
                        {{ term.student.institution_name }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap caption1 text-secondary">
                        {{ term.end_date|date:"M d, Y" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="tag bg-blue bg-opacity-10 text-blue">
                            {{ term.get_status_display }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right caption1">
                        <a href="{% url 'hr_core:coop_term_manage' term.id %}"
                           class="text-primary hover:underline">
                            {% trans "Manage" %}
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}
{% endif %}
{% endblock %}
