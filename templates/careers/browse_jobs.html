{% extends "base/freelanhub_base.html" %}
{% load static i18n humanize %}

{% block title %}{% trans "Browse Jobs" %} - Zumodra{% endblock %}
{% block meta_description %}{{ meta_description }}{% endblock %}

{% block content %}

{# Breadcrumb #}
{% include "careers/components/_breadcrumb.html" with title="Browse Jobs" heading="Find Your Dream Job" total_jobs=total_jobs %}

{# Jobs List Section #}
<section class="jobs_default lg:py-20 sm:py-14 py-10">
    <div class="container">
        {# Filter Bar with View Toggle #}
        {% include "careers/components/_filter_bar.html" with view_mode="grid" %}

        {# Jobs Grid #}
        {% if jobs %}
        <ul class="list_layout_cols list_jobs grid xl:grid-cols-3 sm:grid-cols-2 md:gap-7.5 gap-6 w-full md:mt-10 mt-7">
            {% for job in jobs %}
                {% include "careers/components/_job_card.html" %}
            {% endfor %}
        </ul>

        {# Pagination #}
        {% include "careers/components/_pagination.html" %}

        {% else %}
        {# No Jobs Found #}
        <div class="text-center py-16">
            <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="ph ph-briefcase text-4xl text-gray-400"></i>
            </div>
            <h3 class="heading5 mb-2">{% trans "No Jobs Found" %}</h3>
            <p class="text-secondary">
                {% if search or selected_category or selected_location or selected_job_type or selected_remote %}
                    {% trans "Try adjusting your filters to see more results." %}
                {% else %}
                    {% trans "There are currently no open positions. Check back later!" %}
                {% endif %}
            </p>
        </div>
        {% endif %}
    </div>
</section>

{% endblock %}

{% block extra_js %}
<script>
// === JOB LOCATIONS DATA ===
const jobLocations = [
    {% for job in jobs %}
    {
        id: {{ job.id }},
        title: "{{ job.job.title|escapejs }}",
        company: "{{ job.job.tenant.name|default:'Company'|escapejs }}",
        location: "{{ job.job.location_city|default:'Remote'|escapejs }}",
        job_type: "{{ job.job.job_type|default:'Full-time'|escapejs }}",
        posted_date: "{{ job.job.created_at|date:'Y-m-d' }}",
        {% if job.job.location_coordinates %}
        location_coordinates: {
            lat: {{ job.job.location_coordinates.y }},
            lng: {{ job.job.location_coordinates.x }}
        },
        {% endif %}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// === WEBSOCKET REAL-TIME UPDATES ===
let ws = null;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;
const reconnectDelays = [1000, 2000, 4000, 8000, 16000, 30000];

function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/careers/live/?channel=jobs`;

    console.log('[WebSocket] Connecting to:', wsUrl);

    try {
        ws = new WebSocket(wsUrl);

        ws.onopen = function(event) {
            console.log('[WebSocket] Connected to careers live updates');
            reconnectAttempts = 0;
        };

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            console.log('[WebSocket] Message received:', data.type);

            switch(data.type) {
                case 'job_created':
                    handleJobCreated(data.job);
                    break;
                case 'job_updated':
                    handleJobUpdated(data.job);
                    break;
                case 'job_deleted':
                    handleJobDeleted(data.job_id);
                    break;
            }
        };

        ws.onerror = function(error) {
            console.error('[WebSocket] Error:', error);
        };

        ws.onclose = function(event) {
            console.log('[WebSocket] Connection closed');
            attemptReconnect();
        };

    } catch (error) {
        console.error('[WebSocket] Connection failed:', error);
        attemptReconnect();
    }
}

function attemptReconnect() {
    if (reconnectAttempts >= maxReconnectAttempts) {
        console.error('[WebSocket] Max reconnection attempts reached');
        return;
    }

    const delay = reconnectDelays[Math.min(reconnectAttempts, reconnectDelays.length - 1)];
    console.log(`[WebSocket] Reconnecting in ${delay}ms (attempt ${reconnectAttempts + 1}/${maxReconnectAttempts})`);

    setTimeout(() => {
        reconnectAttempts++;
        connectWebSocket();
    }, delay);
}

function handleJobCreated(job) {
    console.log('[WebSocket] Job created:', job);

    // Add to job locations array
    jobLocations.unshift(job);

    // Add job card to list
    const jobCard = createJobCard(job);
    const jobsList = document.querySelector('.list_jobs');
    if (jobsList) {
        jobsList.insertAdjacentHTML('afterbegin', jobCard);

        // Animate in
        const newCard = jobsList.firstElementChild;
        newCard.style.opacity = '0';
        newCard.style.transform = 'translateY(-20px)';
        setTimeout(() => {
            newCard.style.transition = 'all 0.3s ease';
            newCard.style.opacity = '1';
            newCard.style.transform = 'translateY(0)';
        }, 10);
    }

    updateResultCount(jobLocations.length);
}

function handleJobUpdated(job) {
    console.log('[WebSocket] Job updated:', job);

    // Update in array
    const index = jobLocations.findIndex(j => j.id === job.id);
    if (index !== -1) {
        jobLocations[index] = job;
    }

    // Update card in DOM
    const jobCard = document.querySelector(`[data-job-id="${job.id}"]`);
    if (jobCard) {
        const updatedCard = createJobCard(job);
        const temp = document.createElement('div');
        temp.innerHTML = updatedCard;
        jobCard.replaceWith(temp.firstElementChild);

        // Pulse animation
        const newCard = document.querySelector(`[data-job-id="${job.id}"]`);
        if (newCard) {
            newCard.classList.add('animate-pulse');
            setTimeout(() => newCard.classList.remove('animate-pulse'), 1000);
        }
    }
}

function handleJobDeleted(jobId) {
    console.log('[WebSocket] Job deleted:', jobId);

    // Remove from array
    const index = jobLocations.findIndex(j => j.id === jobId);
    if (index !== -1) {
        jobLocations.splice(index, 1);
    }

    // Remove card with fade-out animation
    const jobCard = document.querySelector(`[data-job-id="${jobId}"]`);
    if (jobCard) {
        jobCard.style.transition = 'all 0.3s ease';
        jobCard.style.opacity = '0';
        jobCard.style.transform = 'scale(0.9)';
        setTimeout(() => jobCard.remove(), 300);
    }

    updateResultCount(jobLocations.length);
}

function createJobCard(job) {
    return `
        <li class="jobs_item relative p-6 rounded-lg bg-white shadow-md duration-300" data-job-id="${job.id}">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-15 h-15 bg-surface rounded flex-shrink-0 flex items-center justify-center">
                        <span class="ph ph-briefcase text-2xl text-secondary"></span>
                    </div>
                    <div>
                        <a href="#" class="jobs_name heading6 duration-300 hover:text-primary">${job.title}</a>
                        <div class="jobs_company text-secondary mt-1">
                            <span class="ph ph-buildings text-lg"></span>
                            <span class="caption1 align-top">${job.company}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="jobs_info flex flex-wrap items-center gap-3 mt-4">
                <div class="flex items-center gap-1">
                    <span class="ph ph-map-pin text-lg text-secondary"></span>
                    <span class="caption1 text-secondary">${job.location}</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="ph ph-clock text-lg text-secondary"></span>
                    <span class="caption1 text-secondary">${job.job_type}</span>
                </div>
            </div>
            <button class="add_wishlist_btn absolute top-5 right-5 -border">
                <span class="ph ph-heart text-xl"></span>
                <span class="ph-fill ph-heart text-xl"></span>
            </button>
        </li>
    `;
}

function updateResultCount(count) {
    const breadcrumbCount = document.querySelector('.breadcrumb .total-count');
    if (breadcrumbCount) {
        breadcrumbCount.textContent = count;
    }
}

// === WISHLIST FUNCTIONALITY ===
document.addEventListener('click', function(e) {
    if (e.target.closest('.add_wishlist_btn')) {
        const btn = e.target.closest('.add_wishlist_btn');
        btn.classList.toggle('active');
        // TODO: Add AJAX call to save wishlist
    }
});

// === INITIALIZATION ===
document.addEventListener('DOMContentLoaded', function() {
    connectWebSocket();
    console.log('[Browse Jobs] Initialized with', jobLocations.length, 'jobs');
});
</script>
{% endblock %}
