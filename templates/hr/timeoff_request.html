{% extends "base/freelanhub_dashboard_base.html" %}
{% load static i18n humanize %}

{% block title %}{% trans "Request Time Off" %} - Zumodra{% endblock %}



{% block page_title %}{% trans "Request Time Off" %}{% endblock %}

{% block page_description %}
<p class="mt-1 caption1 text-secondary ">
    {% trans "Submit a new time off request for approval." %}
</p>
{% endblock %}

{% block dashboard_content %}
{% if request.tenant.tenant_type != 'company' %}
<div class="bg-yellow-50  border-l-4 border-yellow-400  p-4 rounded-lg">
    <div class="flex">
        <div class="flex-shrink-0">
            <i class="ph ph-warning text-yellow heading4"></i>
        </div>
        <div class="ml-3">
            <p class="caption1 text-yellow-700 ">
                {% trans "HR features are only available for company tenants." %}
                <a href="{% url 'tenants:tenant_settings' %}" class="font-medium underline hover:text-yellow-600 ">
                    {% trans "Switch to company account" %}
                </a>
            </p>
        </div>
    </div>
</div>
{% else %}
<div id="main-content" x-data="timeOffRequest()">
    <div class="max-w-3xl mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-7.5">
            {% comment %} Left: Form {% endcomment %}
            <div class="lg:col-span-2">
                <form hx-post="{% url 'frontend:hr:timeoff-request' %}"
                      hx-target="#form-response"
                      hx-swap="innerHTML"
                      @htmx:after-request="if(event.detail.successful && event.detail.xhr.status === 200) $dispatch('timeoff-submitted')"
                      class="bg-white  shadow-sm rounded-lg overflow-hidden">
                    {% csrf_token %}

                    <div class="px-6 py-4 border-b border-gray-200 ">
                        <h3 class="heading5 font-medium text-title ">{% trans "Time Off Details" %}</h3>
                    </div>

                    <div class="p-8 space-y-6">
                        {% comment %} Time Off Type {% endcomment %}
                        <div>
                            <label for="time_off_type" class="block caption1 font-medium text-title  mb-2">
                                {% trans "Type of Time Off" %} <span class="text-red-500">*</span>
                            </label>
                            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                {% for type in time_off_types %}
                                <label class="relative">
                                    <input type="radio" name="time_off_type" value="{{ type.id }}"
                                           x-model="selectedType"
                                           @change="checkBalance({{ type.id }})"
                                           class="peer sr-only" required>
                                    <div class="p-4 border-2 rounded-lg cursor-pointer transition-all
                                                peer-checked:border-primary-500 peer-checked:bg-primary-50 
                                                border-gray-200  hover:border-gray-300 ">
                                        <div class="flex items-center">
                                            <span class="w-3 h-3 rounded-full mr-2" style="background-color: {{ type.color|default:'#3b82f6' }};"></span>
                                            <span class="caption1 font-medium text-title ">{{ type.name }}</span>
                                        </div>
                                        {% for balance in balances %}
                                        {% if balance.time_off_type.id == type.id %}
                                        <p class="mt-1 caption2 text-secondary ">
                                            {{ balance.balance|floatformat:1 }} {% trans "days available" %}
                                        </p>
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        {% comment %} Date Selection {% endcomment %}
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                            <div>
                                <label for="start_date" class="block caption1 font-medium text-title  mb-2">
                                    {% trans "Start Date" %} <span class="text-red-500">*</span>
                                </label>
                                <input type="date"
                                       id="start_date"
                                       name="start_date"
                                       x-model="startDate"
                                       @change="calculateDays()"
                                       min="{{ today }}"
                                       required
                                       class="block w-full px-3 py-2 border border-gray-300  rounded-lg bg-white  text-title  focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent caption1">
                            </div>
                            <div>
                                <label for="end_date" class="block caption1 font-medium text-title  mb-2">
                                    {% trans "End Date" %} <span class="text-red-500">*</span>
                                </label>
                                <input type="date"
                                       id="end_date"
                                       name="end_date"
                                       x-model="endDate"
                                       @change="calculateDays()"
                                       :min="startDate || '{{ today }}'"
                                       required
                                       class="block w-full px-3 py-2 border border-gray-300  rounded-lg bg-white  text-title  focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent caption1">
                            </div>
                        </div>

                        {% comment %} Half Day Option {% endcomment %}
                        <div x-show="startDate === endDate && startDate !== ''" x-transition>
                            <div class="flex items-center space-x-4">
                                <label class="inline-flex items-center">
                                    <input type="checkbox"
                                           name="is_half_day"
                                           x-model="isHalfDay"
                                           @change="calculateDays()"
                                           value="true"
                                           class="w-4 h-4 text-primary-600 bg-gray-100  border-gray-300  rounded focus:ring-primary-500">
                                    <span class="ml-2 caption1 text-title ">{% trans "Half day only" %}</span>
                                </label>
                                <div x-show="isHalfDay" x-transition class="flex items-center space-x-4">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="half_day_period" value="am" x-model="halfDayPeriod"
                                               class="w-4 h-4 text-primary-600 bg-gray-100  border-gray-300  focus:ring-primary-500">
                                        <span class="ml-2 caption1 text-title ">{% trans "Morning" %}</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="half_day_period" value="pm" x-model="halfDayPeriod"
                                               class="w-4 h-4 text-primary-600 bg-gray-100  border-gray-300  focus:ring-primary-500">
                                        <span class="ml-2 caption1 text-title ">{% trans "Afternoon" %}</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        {% comment %} Calculated Days Display {% endcomment %}
                        <div x-show="totalDays > 0" x-transition
                             class="bg-primary-50  rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <span class="caption1 font-medium text-primary-900 ">{% trans "Total Time Off" %}</span>
                                <span class="heading5 font-semibold text-primary-700 " x-text="totalDays + ' ' + (totalDays == 1 ? '{% trans "day" %}' : '{% trans "days" %}')"></span>
                            </div>
                        </div>

                        {% comment %} Reason {% endcomment %}
                        <div>
                            <label for="reason" class="block caption1 font-medium text-title  mb-2">
                                {% trans "Reason" %} <span class="text-secondary">({% trans "optional" %})</span>
                            </label>
                            <textarea id="reason"
                                      name="reason"
                                      rows="3"
                                      class="block w-full px-3 py-2 border border-gray-300  rounded-lg bg-white  text-title  placeholder-gray-500  focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent caption1 resize-none"
                                      placeholder="{% trans 'Add any notes or reason for this time off request...' %}"></textarea>
                        </div>

                        {% comment %} Supporting Document {% endcomment %}
                        <div>
                            <label for="document" class="block caption1 font-medium text-title  mb-2">
                                {% trans "Supporting Document" %} <span class="text-secondary">({% trans "optional" %})</span>
                            </label>
                            <div class="flex items-center justify-center w-full">
                                <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300  border-dashed rounded-lg cursor-pointer bg-gray-50  hover:bg-gray-100  transition-colors">
                                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                        <svg class="w-8 h-8 mb-3 text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                        </svg>
                                        <p class="mb-2 caption1 text-secondary ">
                                            <span class="font-semibold">{% trans "Click to upload" %}</span> {% trans "or drag and drop" %}
                                        </p>
                                        <p class="caption2 text-secondary ">{% trans "PDF, PNG, JPG (MAX. 10MB)" %}</p>
                                    </div>
                                    <input id="document" name="document" type="file" class="hidden" accept=".pdf,.png,.jpg,.jpeg" />
                                </label>
                            </div>
                        </div>

                        {% comment %} Form Response Area {% endcomment %}
                        <div id="form-response"></div>
                    </div>

                    {% comment %} Form Actions {% endcomment %}
                    <div class="px-6 py-4 bg-gray-50  border-t border-gray-200  flex items-center justify-end space-x-3">
                        <a href="{% url 'frontend:hr:my-time-off' %}"
                           class="px-4 py-2 border border-gray-300  caption1 font-medium rounded-lg text-title  bg-white  hover:bg-gray-50  transition-colors">
                            {% trans "Cancel" %}
                        </a>
                        <button type="submit"
                                :disabled="!isValid"
                                :class="isValid ? 'bg-primary-600 hover:bg-primary-700' : 'bg-gray-400 cursor-not-allowed'"
                                class="inline-flex items-center px-4 py-2 border border-transparent caption1 font-medium rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors">
                            <svg class="w-4 h-4 mr-2 -ml-1 htmx-indicator" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            {% trans "Submit Request" %}
                        </button>
                    </div>
                </form>
            </div>

            {% comment %} Right: Balance Summary {% endcomment %}
            <div>
                {% comment %} Current Balances {% endcomment %}
                <div class="bg-white  shadow-sm rounded-lg overflow-hidden mb-7.5">
                    <div class="px-6 py-4 border-b border-gray-200 ">
                        <h3 class="caption1 font-medium text-title ">{% trans "Your Balances" %}</h3>
                    </div>
                    <div class="p-8 space-y-4">
                        {% for balance in balances %}
                        <div>
                            <div class="flex items-center justify-between mb-1">
                                <div class="flex items-center">
                                    <span class="w-2 h-2 rounded-full mr-2" style="background-color: {{ balance.time_off_type.color|default:'#3b82f6' }};"></span>
                                    <span class="caption1 text-title ">{{ balance.time_off_type.name }}</span>
                                </div>
                                <span class="caption1 font-medium text-title ">{{ balance.balance|floatformat:1 }}</span>
                            </div>
                            <div class="w-full bg-gray-200  rounded-full h-1.5">
                                {% widthratio balance.balance balance.time_off_type.max_balance 100 as balance_percent %}
                                <div class="h-1.5 rounded-full" style="width: {{ balance_percent|default:100 }}%; background-color: {{ balance.time_off_type.color|default:'#3b82f6' }};"></div>
                            </div>
                            {% if balance.pending > 0 %}
                            <p class="caption2 text-yellow-600  mt-1">
                                {{ balance.pending|floatformat:1 }} {% trans "days pending" %}
                            </p>
                            {% endif %}
                        </div>
                        {% empty %}
                        <p class="caption1 text-secondary  text-center">{% trans "No balances found." %}</p>
                        {% endfor %}
                    </div>
                </div>

                {% comment %} Request Guidelines {% endcomment %}
                <div class="bg-white  shadow-sm rounded-lg overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200 ">
                        <h3 class="caption1 font-medium text-title ">{% trans "Guidelines" %}</h3>
                    </div>
                    <div class="p-8">
                        <ul class="space-y-3 caption1 text-title ">
                            <li class="flex items-start">
                                <i class="ph ph-check-circle text-green heading4"></i>
                                <span>{% trans "Submit requests at least 2 weeks in advance when possible" %}</span>
                            </li>
                            <li class="flex items-start">
                                <i class="ph ph-check-circle text-green heading4"></i>
                                <span>{% trans "Your manager will be notified automatically" %}</span>
                            </li>
                            <li class="flex items-start">
                                <i class="ph ph-check-circle text-green heading4"></i>
                                <span>{% trans "Sick leave may require documentation after 3 consecutive days" %}</span>
                            </li>
                            <li class="flex items-start">
                                <i class="ph ph-warning text-yellow heading4"></i>
                                <span>{% trans "Check blackout dates before requesting time during peak periods" %}</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
function timeOffRequest() {
    return {
        selectedType: '',
        startDate: '',
        endDate: '',
        isHalfDay: false,
        halfDayPeriod: 'am',
        totalDays: 0,
        balances: {{ balances_json|default:"{}"|safe }},

        get isValid() {
            return this.selectedType && this.startDate && this.endDate && this.totalDays > 0;
        },

        calculateDays() {
            if (!this.startDate || !this.endDate) {
                this.totalDays = 0;
                return;
            }

            const start = new Date(this.startDate);
            const end = new Date(this.endDate);

            if (end < start) {
                this.totalDays = 0;
                return;
            }

            if (this.isHalfDay && this.startDate === this.endDate) {
                this.totalDays = 0.5;
                return;
            }

            // Count weekdays only
            let days = 0;
            const current = new Date(start);
            while (current <= end) {
                const dayOfWeek = current.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Not Sunday (0) or Saturday (6)
                    days++;
                }
                current.setDate(current.getDate() + 1);
            }
            this.totalDays = days;
        },

        checkBalance(typeId) {
            // Could add balance validation here
            this.calculateDays();
        }
    }
}
</script>
{% endif %}
{% endblock %}