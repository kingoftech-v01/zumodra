{% extends "base/public_base.html" %}
{% load static i18n humanize %}

{% block title %}{% trans "Browse Services" %} - Zumodra{% endblock %}

{% block meta_description %}{% trans "Discover professional services from verified providers. Find the perfect freelancer for your project." %}{% endblock %}

{% block content %}
<div class="zu-page-bg min-h-screen">
    <!-- Hero Section -->
    <div class="zu-hero zu-hero--primary">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 lg:py-16">
            <div class="text-center">
                <h1 class="zu-hero__title">
                    {% trans "Find Professional Services" %}
                </h1>
                <p class="zu-hero__subtitle">
                    {% trans "Connect with talented professionals ready to help you achieve your goals." %}
                </p>

                <!-- Search Bar -->
                <form method="get" action="" class="max-w-3xl mx-auto mt-8" id="search-form">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="flex-1 relative">
                            <input type="text"
                                   name="search"
                                   value="{{ search }}"
                                   hx-get="{% url 'services:service_list' %}"
                                   hx-trigger="keyup changed delay:500ms"
                                   hx-target="#services-grid"
                                   hx-swap="innerHTML"
                                   hx-include="#search-form"
                                   class="zu-input zu-input--lg zu-input--search"
                                   placeholder="{% trans 'Search for services...' %}">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <svg class="zu-icon zu-icon--muted" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <path d="m21 21-4.35-4.35"></path>
                                </svg>
                            </div>
                        </div>
                        <button type="submit" class="zu-btn zu-btn--glass zu-btn--lg">
                            {% trans "Search" %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="lg:grid lg:grid-cols-4 lg:gap-8">

            <!-- Sidebar Filters -->
            <aside class="hidden lg:block lg:col-span-1">
                <div class="sticky top-24 space-y-6">
                    <!-- Categories Filter -->
                    <div class="zu-card">
                        <div class="zu-card__header">
                            <h3 class="zu-card__title">{% trans "Categories" %}</h3>
                        </div>
                        <div class="zu-card__body">
                            <div class="space-y-3">
                                <a href="{% url 'services:service_list' %}"
                                   class="zu-link {% if not request.GET.category %}zu-link--active{% endif %}">
                                    {% trans "All Categories" %}
                                </a>
                                {% for category in categories %}
                                <a href="?category={{ category.id }}{% if search %}&search={{ search }}{% endif %}"
                                   hx-get="{% url 'services:service_list' %}?category={{ category.id }}{% if search %}&search={{ search }}{% endif %}"
                                   hx-target="#services-grid"
                                   hx-swap="innerHTML"
                                   class="zu-link {% if request.GET.category == category.id|stringformat:'s' %}zu-link--active{% endif %}">
                                    {{ category.name }}
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Price Range Filter -->
                    <div class="zu-card">
                        <div class="zu-card__header">
                            <h3 class="zu-card__title">{% trans "Price Range" %}</h3>
                        </div>
                        <div class="zu-card__body">
                            <div class="space-y-4">
                                <div>
                                    <label class="zu-label">{% trans "Min Price" %}</label>
                                    <input type="number"
                                           name="min_price"
                                           value="{{ request.GET.min_price }}"
                                           hx-get="{% url 'services:service_list' %}"
                                           hx-trigger="change"
                                           hx-target="#services-grid"
                                           hx-swap="innerHTML"
                                           hx-include="#search-form"
                                           class="zu-input"
                                           placeholder="$0">
                                </div>
                                <div>
                                    <label class="zu-label">{% trans "Max Price" %}</label>
                                    <input type="number"
                                           name="max_price"
                                           value="{{ request.GET.max_price }}"
                                           hx-get="{% url 'services:service_list' %}"
                                           hx-trigger="change"
                                           hx-target="#services-grid"
                                           hx-swap="innerHTML"
                                           hx-include="#search-form"
                                           class="zu-input"
                                           placeholder="$1000">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Popular Tags -->
                    <div class="zu-card">
                        <div class="zu-card__header">
                            <h3 class="zu-card__title">{% trans "Popular Tags" %}</h3>
                        </div>
                        <div class="zu-card__body">
                            <div class="flex flex-wrap gap-2">
                                {% for tag in popular_tags %}
                                <a href="?tag={{ tag.name }}{% if search %}&search={{ search }}{% endif %}"
                                   hx-get="{% url 'services:service_list' %}?tag={{ tag.name }}{% if search %}&search={{ search }}{% endif %}"
                                   hx-target="#services-grid"
                                   hx-swap="innerHTML"
                                   class="zu-badge {% if request.GET.tag == tag.name %}zu-badge--primary{% else %}zu-badge--muted{% endif %}">
                                    {{ tag.name }}
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Services Grid -->
            <div class="lg:col-span-3">
                <!-- Sort & View Options -->
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-4">
                    <p class="zu-text zu-text--muted">
                        {% blocktrans with count=services.paginator.count %}
                        {{ count }} services found
                        {% endblocktrans %}
                    </p>
                    <div class="flex items-center gap-4">
                        <select name="sort"
                                hx-get="{% url 'services:service_list' %}"
                                hx-trigger="change"
                                hx-target="#services-grid"
                                hx-swap="innerHTML"
                                hx-include="#search-form"
                                class="zu-select">
                            <option value="-created_at" {% if request.GET.sort == '-created_at' %}selected{% endif %}>{% trans "Newest First" %}</option>
                            <option value="created_at" {% if request.GET.sort == 'created_at' %}selected{% endif %}>{% trans "Oldest First" %}</option>
                            <option value="price" {% if request.GET.sort == 'price' %}selected{% endif %}>{% trans "Price: Low to High" %}</option>
                            <option value="-price" {% if request.GET.sort == '-price' %}selected{% endif %}>{% trans "Price: High to Low" %}</option>
                            <option value="name" {% if request.GET.sort == 'name' %}selected{% endif %}>{% trans "Name A-Z" %}</option>
                        </select>
                    </div>
                </div>

                <!-- Mobile Filter Button -->
                <div class="lg:hidden mb-4">
                    <button type="button"
                            x-data
                            @click="$dispatch('open-filters')"
                            class="zu-btn zu-btn--outline zu-btn--full">
                        <svg class="zu-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                        </svg>
                        {% trans "Filters" %}
                    </button>
                </div>

                <!-- Services Grid -->
                <div id="services-grid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
                    {% for service in services %}
                    <div class="zu-card zu-card--hover">
                        <!-- Service Thumbnail -->
                        <a href="{% url 'service_detail' service.uuid %}" class="block">
                            <div class="zu-card__image-container">
                                {% if service.thumbnail %}
                                <img src="{{ service.thumbnail.url }}"
                                     alt="{{ service.name }}"
                                     class="zu-card__image"
                                     loading="lazy">
                                {% else %}
                                <div class="zu-card__image-placeholder">
                                    <svg class="zu-icon zu-icon--xl zu-icon--muted" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                                        <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                                    </svg>
                                </div>
                                {% endif %}
                                {% if service.is_featured %}
                                <span class="zu-badge zu-badge--warning zu-badge--floating">
                                    {% trans "Featured" %}
                                </span>
                                {% endif %}
                            </div>
                        </a>

                        <div class="zu-card__body">
                            <!-- Provider Info -->
                            <div class="flex items-center gap-3 mb-3">
                                {% if service.provider.avatar %}
                                <img src="{{ service.provider.avatar.url }}"
                                     alt="{{ service.provider.display_name }}"
                                     class="zu-avatar zu-avatar--sm">
                                {% else %}
                                <div class="zu-avatar zu-avatar--sm">
                                    <span class="zu-avatar__initials">
                                        {{ service.provider.display_name|slice:":1"|upper }}
                                    </span>
                                </div>
                                {% endif %}
                                <div>
                                    <a href="{% url 'provider_profile' service.provider.uuid %}"
                                       class="zu-link zu-link--subtle">
                                        {{ service.provider.display_name }}
                                    </a>
                                    {% if service.provider.is_verified %}
                                    <svg class="zu-icon zu-icon--verified inline ml-1" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path fill-rule="evenodd" d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10zm4.707-12.707a1 1 0 00-1.414-1.414L10 13.172l-2.293-2.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l6-6z" clip-rule="evenodd"/>
                                    </svg>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Service Title -->
                            <a href="{% url 'service_detail' service.uuid %}">
                                <h3 class="zu-card__title zu-card__title--truncate-2">
                                    {{ service.name }}
                                </h3>
                            </a>

                            <!-- Rating -->
                            <div class="zu-rating mb-3">
                                <svg class="zu-icon zu-icon--star" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                </svg>
                                <span class="zu-rating__value">
                                    {{ service.provider.rating_avg|floatformat:1 }}
                                </span>
                                <span class="zu-rating__count">
                                    ({{ service.provider.total_reviews }})
                                </span>
                            </div>

                            <!-- Tags -->
                            {% if service.tags.exists %}
                            <div class="flex flex-wrap gap-1 mb-4">
                                {% for tag in service.tags.all|slice:":3" %}
                                <span class="zu-badge zu-badge--sm zu-badge--muted">
                                    {{ tag.name }}
                                </span>
                                {% endfor %}
                            </div>
                            {% endif %}

                            <!-- Price & CTA -->
                            <div class="zu-card__footer">
                                <div>
                                    <span class="zu-text zu-text--xs zu-text--muted">{% trans "Starting at" %}</span>
                                    <p class="zu-price">
                                        ${{ service.price|intcomma }}
                                    </p>
                                </div>
                                <a href="{% url 'service_detail' service.uuid %}" class="zu-btn zu-btn--ghost zu-btn--sm">
                                    {% trans "View" %}
                                </a>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-span-full zu-empty-state">
                        <svg class="zu-empty-state__icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M8 15h8"></path>
                            <path d="M9 9h.01"></path>
                            <path d="M15 9h.01"></path>
                        </svg>
                        <h3 class="zu-empty-state__title">{% trans "No services found" %}</h3>
                        <p class="zu-empty-state__description">
                            {% trans "Try adjusting your search or filter criteria." %}
                        </p>
                    </div>
                    {% endfor %}
                </div>

                <!-- Pagination -->
                {% if services.has_other_pages %}
                <div class="mt-8">
                    {% include "components/pagination.html" with page_obj=services %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
