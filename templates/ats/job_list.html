{% extends "base/freelanhub_dashboard_base.html" %}
{% load static i18n humanize %}

{% block page_title %}{% trans "My Jobs" %}{% endblock %}

{% block dashboard_content %}
    <div class="flex flex-wrap items-center justify-between gap-4">
        <h4 class="heading4 max-lg:mt-3">{% trans "My Jobs" %}</h4>
        <a href="{% url 'frontend:ats:job_create' %}" class="button-main">
            <span class="ph ph-plus text-xl mr-2"></span>
            {% trans "Submit new Job" %}
        </a>
    </div>

    <!-- Jobs Table Card -->
    <div class="mt-7.5 rounded-lg bg-white">
        <!-- Tab Navigation -->
        <div class="list_category flex items-center h-20 p-6 border-b border-line">
            <div class="menu_tab overflow-unset max-w-none">
                <ul class="menu flex gap-7" role="tablist">
                    <li class="indicator absolute bottom-0 h-0.5 bg-primary rounded-full duration-300"></li>
                    <li class="tab_item" role="presentation">
                        <button class="tab_btn -before py-1 text-button hover:text-primary duration-300 {% if status == 'all' or not status %}active{% endif %}"
                                hx-get="{% url 'frontend:ats:job_list' %}?status=all"
                                hx-target="#jobs-table-container"
                                hx-swap="innerHTML">
                            {% trans "All Jobs" %} ({{ all_jobs_count }})
                        </button>
                    </li>
                    <li class="tab_item" role="presentation">
                        <button class="tab_btn -before py-1 text-button hover:text-primary duration-300 {% if status == 'published' %}active{% endif %}"
                                hx-get="{% url 'frontend:ats:job_list' %}?status=published"
                                hx-target="#jobs-table-container"
                                hx-swap="innerHTML">
                            {% trans "Published" %} ({{ published_count }})
                        </button>
                    </li>
                    <li class="tab_item" role="presentation">
                        <button class="tab_btn -before py-1 text-button hover:text-primary duration-300 {% if status == 'draft' %}active{% endif %}"
                                hx-get="{% url 'frontend:ats:job_list' %}?status=draft"
                                hx-target="#jobs-table-container"
                                hx-swap="innerHTML">
                            {% trans "Drafts" %} ({{ draft_count }})
                        </button>
                    </li>
                    <li class="tab_item" role="presentation">
                        <button class="tab_btn -before py-1 text-button hover:text-primary duration-300 {% if status == 'closed' %}active{% endif %}"
                                hx-get="{% url 'frontend:ats:job_list' %}?status=closed"
                                hx-target="#jobs-table-container"
                                hx-swap="innerHTML">
                            {% trans "Closed" %} ({{ closed_count }})
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="flex flex-wrap items-center justify-between gap-5 pt-5 px-6">
            <form class="relative w-[340px] h-12" method="get" action="">
                <input type="text" name="search" value="{{ search_query|default:'' }}"
                       class="w-full h-full pl-4 pr-12 border border-line rounded-lg overflow-hidden"
                       placeholder="{% trans 'Search by keyword' %}" />
                <button type="submit" class="absolute top-1/2 -translate-y-1/2 right-4">
                    <span class="ph ph-magnifying-glass text-xl block"></span>
                </button>
            </form>
            <div class="select_block sm:pr-16 pr-10 pl-3 py-2 border border-line rounded">
                <div class="select">
                    <span class="selected caption1 capitalize" data-title="sort by (default)">{% trans "sort by (default)" %}</span>
                    <ul class="list_option scrollbar_custom max-h-[200px] p-0 bg-white">
                        <li class="capitalize" data-item="default">{% trans "sort by (default)" %}</li>
                        <li class="capitalize" data-item="title (a -> z)">{% trans "title (a -> z)" %}</li>
                        <li class="capitalize" data-item="title (z -> a)">{% trans "title (z -> a)" %}</li>
                        <li class="capitalize" data-item="newest first">{% trans "newest first" %}</li>
                        <li class="capitalize" data-item="oldest first">{% trans "oldest first" %}</li>
                        <li class="capitalize" data-item="most applicants">{% trans "most applicants" %}</li>
                    </ul>
                </div>
                <span class="icon_down ph ph-caret-down right-3"></span>
            </div>
        </div>

        <!-- Jobs Table -->
        <div id="jobs-table-container">
            <div class="list overflow-x-auto w-full p-5 rounded-xl">
                <table class="w-full max-[1400px]:w-[1200px] max-md:w-[1000px]">
                    <thead class="border-b border-line">
                        <tr>
                            <th scope="col" class="px-5 py-4 text-left text-sm font-bold uppercase text-secondary whitespace-nowrap">{% trans "Job Title" %}</th>
                            <th scope="col" class="px-5 py-4 text-left text-sm font-bold uppercase text-secondary whitespace-nowrap">{% trans "Created & Expiry" %}</th>
                            <th scope="col" class="px-5 py-4 text-left text-sm font-bold uppercase text-secondary whitespace-nowrap">{% trans "Status" %}</th>
                            <th scope="col" class="px-5 py-4 text-left text-sm font-bold uppercase text-secondary whitespace-nowrap">{% trans "Applicants" %}</th>
                            <th scope="col" class="px-5 py-4 text-right text-sm font-bold uppercase text-secondary whitespace-nowrap">{% trans "Action" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for job in jobs %}
                        <tr class="item duration-300 hover:bg-background">
                            <th scope="row" class="p-5 text-left">
                                <a href="{% url 'frontend:ats:job_detail' job.id %}" class="block">
                                    <strong class="job_title -style-1 heading6 duration-300 hover:text-primary">{{ job.title }}</strong>
                                    <div class="address flex items-center gap-2 mt-1 text-secondary">
                                        <span class="ph ph-map-pin text-xl"></span>
                                        <span class="job_location font-normal">{{ job.location|default:"Remote" }}</span>
                                    </div>
                                </a>
                            </th>
                            <td class="p-5">
                                <p>{% trans "Created:" %} {{ job.created_at|date:"M d, Y" }}</p>
                                {% if job.expiry_date %}
                                <p>{% trans "Expiry:" %} {{ job.expiry_date|date:"M d, Y" }}</p>
                                {% else %}
                                <p class="text-secondary">{% trans "No expiry" %}</p>
                                {% endif %}
                            </td>
                            <td class="p-5">
                                {% if job.status == 'published' %}
                                <span class="tag bg-opacity-10 bg-success text-success text-button">{% trans "Published" %}</span>
                                {% elif job.status == 'draft' %}
                                <span class="tag bg-opacity-10 bg-yellow text-yellow text-button">{% trans "Draft" %}</span>
                                {% elif job.status == 'closed' %}
                                <span class="tag bg-opacity-10 bg-placehover text-placehover text-button">{% trans "Closed" %}</span>
                                {% elif job.is_expired %}
                                <span class="tag bg-opacity-10 bg-red text-red text-button">{% trans "Expired" %}</span>
                                {% endif %}
                            </td>
                            <td class="p-5 whitespace-nowrap">
                                <a href="{% url 'frontend:ats:application_list' %}?job={{ job.id }}" class="button-main -border -small text-button-sm">
                                    {% trans "view Applicants" %} ({{ job.applications_count|default:0 }})
                                </a>
                            </td>
                            <td class="p-5">
                                <div class="flex justify-end gap-2">
                                    <a href="{% url 'frontend:ats:job_detail' job.id %}" class="btn_action flex items-center justify-center relative w-10 h-10 rounded border border-line duration-300 hover:bg-primary hover:text-white">
                                        <span class="ph ph-eye text-xl"></span>
                                        <span class="flag absolute -top-10 left-1/2 py-0.5 px-1.5 rounded border border-line bg-white caption1 capitalize text-black whitespace-nowrap">{% trans "View Job" %}</span>
                                    </a>
                                    {% if job.status == 'published' %}
                                    <button hx-post="{% url 'frontend:ats:job_close' job.id %}"
                                            hx-confirm="{% trans 'Are you sure you want to close this job?' %}"
                                            hx-target="closest tr"
                                            hx-swap="outerHTML"
                                            class="btn_action flex items-center justify-center relative w-10 h-10 rounded border border-line duration-300 hover:bg-primary hover:text-white">
                                        <span class="ph ph-lock text-xl"></span>
                                        <span class="flag absolute -top-10 left-1/2 py-0.5 px-1.5 rounded border border-line bg-white caption1 capitalize text-black whitespace-nowrap">{% trans "Close Job" %}</span>
                                    </button>
                                    {% endif %}
                                    <a href="{% url 'frontend:ats:job_edit' job.id %}" class="btn_action flex items-center justify-center relative w-10 h-10 rounded border border-line duration-300 hover:bg-primary hover:text-white">
                                        <span class="ph ph-pencil-simple-line text-xl"></span>
                                        <span class="flag absolute -top-10 left-1/2 py-0.5 px-1.5 rounded border border-line bg-white caption1 capitalize text-black whitespace-nowrap">{% trans "Edit Job" %}</span>
                                    </a>
                                    <button hx-delete="{% url 'frontend:ats:job_delete' job.id %}"
                                            hx-confirm="{% trans 'Are you sure you want to delete this job?' %}"
                                            hx-target="closest tr"
                                            hx-swap="outerHTML"
                                            class="btn_action flex items-center justify-center relative w-10 h-10 rounded border border-line duration-300 hover:bg-primary hover:text-white">
                                        <span class="ph ph-trash text-xl"></span>
                                        <span class="flag absolute -top-10 left-1/2 py-0.5 px-1.5 rounded border border-line bg-white caption1 capitalize text-black whitespace-nowrap">{% trans "Delete" %}</span>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="p-12 text-center">
                                <span class="ph ph-briefcase text-6xl text-secondary block mb-4"></span>
                                <h3 class="heading6 mb-2">{% trans "No jobs found" %}</h3>
                                <p class="text-secondary mb-4">{% trans "Create your first job posting to get started." %}</p>
                                <a href="{% url 'frontend:ats:job_create' %}" class="button-main -small">
                                    {% trans "Post New Job" %}
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if jobs.has_other_pages %}
            <div class="px-6 pb-6">
                {% include 'components/dashboard/pagination.html' with page_obj=jobs %}
            </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // Tab indicator animation
    document.addEventListener('DOMContentLoaded', function() {
        const tabs = document.querySelectorAll('.tab_btn');
        const indicator = document.querySelector('.indicator');

        function updateIndicator() {
            const activeTab = document.querySelector('.tab_btn.active');
            if (activeTab && indicator) {
                const tabRect = activeTab.getBoundingClientRect();
                const menuRect = activeTab.closest('.menu').getBoundingClientRect();
                indicator.style.width = tabRect.width + 'px';
                indicator.style.left = (tabRect.left - menuRect.left) + 'px';
            }
        }

        updateIndicator();
        window.addEventListener('resize', updateIndicator);

        // Update indicator on HTMX swap
        document.body.addEventListener('htmx:afterSwap', updateIndicator);
    });
</script>
{% endblock %}
