{% extends "base/freelanhub_dashboard_base.html" %}
{% load static i18n humanize %}

{% block page_title %}Escrow Details{% endblock %}

{% block dashboard_content %}
<!-- Breadcrumb -->
<div class="breadcrumb flex items-center gap-2 mb-6">
    <a href="{% url 'frontend:finance:dashboard' %}" class="text-secondary hover:text-primary caption1">{% trans "Finance" %}</a>
    <span class="ph ph-caret-right text-secondary"></span>
    <a href="{% url 'frontend:finance:escrow-list' %}" class="text-secondary hover:text-primary caption1">{% trans "Escrow" %}</a>
    <span class="ph ph-caret-right text-secondary"></span>
    <span class="text-title caption1">#{{ escrow.id|truncatechars:8 }}</span>
</div>

<!-- Status Banner -->
<div class="p-6 rounded-lg bg-white mb-7.5">
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
            <span class="tag
                {% if escrow.status == 'released' %}bg-green bg-opacity-10 text-green
                {% elif escrow.status == 'dispute' %}bg-red bg-opacity-10 text-red
                {% elif escrow.status == 'funded' or escrow.status == 'service_delivered' %}bg-blue bg-opacity-10 text-blue
                {% else %}bg-grey bg-opacity-10 text-grey{% endif %}">
                {{ escrow.get_status_display }}
            </span>
            <span class="caption1 text-secondary">
                {% trans "Created" %} {{ escrow.created_at|date:"M d, Y" }}
            </span>
        </div>
        <div class="text-right">
            <p class="caption1 text-secondary">{% trans "Amount" %}</p>
            <p class="heading4 text-title">${{ escrow.amount|floatformat:2|intcomma }}</p>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-7.5">
    <!-- Main Content -->
    <div class="lg:col-span-2 space-y-7.5">
        <!-- Parties -->
        <div class="p-8 rounded-lg bg-white">
            <h4 class="heading5 mb-6">{% trans "Parties" %}</h4>
            <div class="grid grid-cols-2 gap-6">
                <div class="p-4 rounded-lg {% if is_buyer %}bg-primary bg-opacity-10 border-2 border-primary{% else %}bg-surface{% endif %}">
                    <p class="caption2 text-secondary uppercase mb-1">{% trans "Buyer" %}</p>
                    <p class="caption1 text-title font-semibold">{{ escrow.buyer.get_full_name }}</p>
                    <p class="caption1 text-secondary">{{ escrow.buyer.email }}</p>
                    {% if is_buyer %}<span class="caption2 text-primary mt-2 inline-block">{% trans "(You)" %}</span>{% endif %}
                </div>
                <div class="p-4 rounded-lg {% if is_seller %}bg-primary bg-opacity-10 border-2 border-primary{% else %}bg-surface{% endif %}">
                    <p class="caption2 text-secondary uppercase mb-1">{% trans "Seller" %}</p>
                    <p class="caption1 text-title font-semibold">{{ escrow.seller.get_full_name }}</p>
                    <p class="caption1 text-secondary">{{ escrow.seller.email }}</p>
                    {% if is_seller %}<span class="caption2 text-primary mt-2 inline-block">{% trans "(You)" %}</span>{% endif %}
                </div>
            </div>
        </div>

        <!-- Agreement Details -->
        {% if escrow.agreement_details %}
        <div class="p-8 rounded-lg bg-white">
            <h4 class="heading5 mb-4">{% trans "Agreement Details" %}</h4>
            <div class="caption1 text-secondary">
                {{ escrow.agreement_details|linebreaks }}
            </div>
        </div>
        {% endif %}

        <!-- Timeline -->
        <div class="p-8 rounded-lg bg-white">
            <h4 class="heading5 mb-6">{% trans "Activity Timeline" %}</h4>
            <div class="flow-root">
                <ul class="-mb-8">
                    {% for log in audit_logs %}
                    <li>
                        <div class="relative pb-8">
                            {% if not forloop.last %}
                            <span class="absolute top-4 left-4 -ml-px h-full w-0.5 bg-line" aria-hidden="true"></span>
                            {% endif %}
                            <div class="relative flex space-x-3">
                                <div>
                                    <span class="h-8 w-8 rounded-full bg-surface flex items-center justify-center ring-8 ring-white">
                                        <span class="ph ph-clock text-secondary"></span>
                                    </span>
                                </div>
                                <div class="min-w-0 flex-1 pt-1.5 flex justify-between space-x-4">
                                    <div>
                                        <p class="caption1 text-title">{{ log.action|title }}</p>
                                        {% if log.notes %}<p class="caption1 text-secondary">{{ log.notes }}</p>{% endif %}
                                    </div>
                                    <div class="text-right caption1 text-secondary whitespace-nowrap">
                                        {{ log.timestamp|date:"M d, H:i" }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </li>
                    {% empty %}
                    <li class="caption1 text-secondary">{% trans "No activity yet" %}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <!-- Disputes -->
        {% if disputes %}
        <div class="p-8 rounded-lg bg-white">
            <h4 class="heading5 mb-6">{% trans "Disputes" %}</h4>
            <div class="space-y-4">
                {% for dispute in disputes %}
                <div class="border border-line rounded-lg p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="caption1 text-title font-semibold">{{ dispute.reason }}</p>
                            <p class="caption1 text-secondary">
                                {% trans "Raised by" %} {{ dispute.raised_by.get_full_name }} {% trans "on" %} {{ dispute.created_at|date:"M d, Y" }}
                            </p>
                        </div>
                        <span class="tag {% if dispute.resolved %}bg-green bg-opacity-10 text-green{% else %}bg-yellow bg-opacity-10 text-yellow{% endif %}">
                            {% if dispute.resolved %}{% trans "Resolved" %}{% else %}{% trans "Open" %}{% endif %}
                        </span>
                    </div>
                    {% if dispute.details %}
                    <p class="mt-2 caption1 text-secondary">{{ dispute.details }}</p>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Actions Sidebar -->
    <div class="space-y-7.5">
        <!-- Actions Card -->
        <div class="p-6 rounded-lg bg-white">
            <h4 class="heading6 mb-4">{% trans "Actions" %}</h4>
            <div class="space-y-3">
                {% if is_buyer and escrow.status == 'initialized' %}
                <button hx-post="{% url 'frontend:finance:escrow-fund' pk=escrow.pk %}"
                        hx-confirm="{% trans 'Fund this escrow with' %} ${{ escrow.amount }}?"
                        class="button-main w-full">
                    {% trans "Fund Escrow" %}
                </button>
                {% endif %}

                {% if is_seller and escrow.status == 'funded' %}
                <button hx-post="{% url 'frontend:finance:escrow-deliver' pk=escrow.pk %}"
                        hx-confirm="{% trans 'Mark service as delivered?' %}"
                        class="button-main w-full">
                    {% trans "Mark as Delivered" %}
                </button>
                {% endif %}

                {% if is_buyer and escrow.status == 'service_delivered' %}
                <button hx-post="{% url 'frontend:finance:escrow-release' pk=escrow.pk %}"
                        hx-confirm="{% trans 'Release funds to seller? This action cannot be undone.' %}"
                        class="button-main w-full bg-green">
                    {% trans "Release Funds" %}
                </button>
                {% endif %}

                {% if escrow.status in 'funded,service_delivered' %}
                <button hx-get="{% url 'frontend:finance:escrow-dispute-form' pk=escrow.pk %}"
                        hx-target="#modal-container"
                        hx-swap="innerHTML"
                        class="button-main -border w-full border-red text-red">
                    {% trans "Raise Dispute" %}
                </button>
                {% endif %}

                {% if is_buyer and escrow.status == 'initialized' %}
                <button hx-post="{% url 'frontend:finance:escrow-cancel' pk=escrow.pk %}"
                        hx-confirm="{% trans 'Cancel this escrow?' %}"
                        class="button-main -border w-full">
                    {% trans "Cancel Escrow" %}
                </button>
                {% endif %}
            </div>
        </div>

        <!-- Key Dates -->
        <div class="p-6 rounded-lg bg-white">
            <h4 class="heading6 mb-4">{% trans "Key Dates" %}</h4>
            <dl class="space-y-3">
                <div class="flex justify-between">
                    <dt class="caption1 text-secondary">{% trans "Created" %}</dt>
                    <dd class="caption1 text-title">{{ escrow.created_at|date:"M d, Y" }}</dd>
                </div>
                {% if escrow.funded_at %}
                <div class="flex justify-between">
                    <dt class="caption1 text-secondary">{% trans "Funded" %}</dt>
                    <dd class="caption1 text-title">{{ escrow.funded_at|date:"M d, Y" }}</dd>
                </div>
                {% endif %}
                {% if escrow.service_delivered_at %}
                <div class="flex justify-between">
                    <dt class="caption1 text-secondary">{% trans "Delivered" %}</dt>
                    <dd class="caption1 text-title">{{ escrow.service_delivered_at|date:"M d, Y" }}</dd>
                </div>
                {% endif %}
                {% if escrow.released_at %}
                <div class="flex justify-between">
                    <dt class="caption1 text-secondary">{% trans "Released" %}</dt>
                    <dd class="caption1 text-title">{{ escrow.released_at|date:"M d, Y" }}</dd>
                </div>
                {% endif %}
            </dl>
        </div>
    </div>
</div>
{% endblock %}
