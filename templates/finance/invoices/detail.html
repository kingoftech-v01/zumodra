{% extends "base/freelanhub_dashboard_base.html" %}
{% load static i18n humanize %}

{% block page_title %}Invoice {{ invoice.invoice_number }}{% endblock %}

{% block dashboard_content %}
<!-- Breadcrumb -->
<div class="breadcrumb flex items-center gap-2 mb-6">
    <a href="{% url 'frontend:finance:dashboard' %}" class="text-secondary hover:text-primary caption1">{% trans "Finance" %}</a>
    <span class="ph ph-caret-right text-secondary"></span>
    <a href="{% url 'frontend:finance:invoices' %}" class="text-secondary hover:text-primary caption1">{% trans "Invoices" %}</a>
    <span class="ph ph-caret-right text-secondary"></span>
    <span class="text-title caption1">{{ invoice.invoice_number }}</span>
</div>

<!-- Page Header -->
<div class="heading flex items-center justify-between mb-7.5">
    <div>
        <h3 class="heading3">{% trans "Invoice" %} {{ invoice.invoice_number }}</h3>
        <p class="caption1 text-secondary mt-1">{% trans "Created" %} {{ invoice.created_at|date:"M d, Y" }}</p>
    </div>
    {% if request.tenant %}
        {% if request.tenant.tenant_type == 'company' %}
            <span class="tag bg-blue bg-opacity-10 text-blue">
                <span class="ph ph-buildings text-lg mr-1"></span>
                {% trans "Company" %}
            </span>
        {% else %}
            <span class="tag bg-green bg-opacity-10 text-green">
                <span class="ph ph-user text-lg mr-1"></span>
                {% trans "Freelancer" %}
            </span>
        {% endif %}
    {% endif %}
</div>

<div class="max-w-3xl mx-auto space-y-7.5">
    <!-- Invoice Header -->
    <div class="p-6 rounded-lg bg-white">
        <div class="flex justify-between items-start">
            <div>
                <h4 class="heading5">{% trans "Invoice" %} {{ invoice.invoice_number }}</h4>
                <p class="caption1 text-secondary mt-1">{% trans "Created" %} {{ invoice.created_at|date:"M d, Y" }}</p>
            </div>
            <span class="tag
                {% if invoice.paid %}bg-green bg-opacity-10 text-green
                {% elif invoice.due_date and invoice.due_date < now %}bg-red bg-opacity-10 text-red
                {% else %}bg-yellow bg-opacity-10 text-yellow{% endif %}">
                {% if invoice.paid %}{% trans "Paid" %}{% elif invoice.due_date and invoice.due_date < now %}{% trans "Overdue" %}{% else %}{% trans "Pending" %}{% endif %}
            </span>
        </div>
    </div>

    <!-- Invoice Details -->
    <div class="p-8 rounded-lg bg-white">
        <h4 class="heading5 mb-6 pb-6 border-b border-line">{% trans "Invoice Details" %}</h4>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
            <div>
                <dt class="caption1 text-secondary mb-1">{% trans "Amount Due" %}</dt>
                <dd class="heading5 text-title">${{ invoice.amount_due|floatformat:2|intcomma }}</dd>
            </div>
            <div>
                <dt class="caption1 text-secondary mb-1">{% trans "Amount Paid" %}</dt>
                <dd class="heading5 text-green">${{ invoice.amount_paid|floatformat:2|intcomma }}</dd>
            </div>
            <div>
                <dt class="caption1 text-secondary mb-1">{% trans "Balance Due" %}</dt>
                <dd class="heading5 text-title">
                    {% with balance=invoice.amount_due|add:"-"|add:invoice.amount_paid %}
                    ${{ balance|floatformat:2|intcomma }}
                    {% endwith %}
                </dd>
            </div>
            <div>
                <dt class="caption1 text-secondary mb-1">{% trans "Due Date" %}</dt>
                <dd class="heading6 text-title">{{ invoice.due_date|date:"M d, Y"|default:"No due date" }}</dd>
            </div>
        </div>
    </div>

    <!-- Pay Invoice (if unpaid) -->
    {% if not invoice.paid %}
    <div class="p-8 rounded-lg bg-white">
        <h4 class="heading5 mb-4">{% trans "Pay Invoice" %}</h4>

        {% if payment_methods %}
        <form hx-post="{% url 'frontend:finance:invoice-pay' invoice_number=invoice.invoice_number %}"
              hx-swap="outerHTML"
              class="space-y-4">
            {% csrf_token %}
            <div>
                <label for="payment_method" class="block caption1 text-title mb-2">{% trans "Payment Method" %}</label>
                <select id="payment_method" name="payment_method_id"
                        class="px-4 py-2 border border-line rounded-lg caption1 text-title w-full">
                    {% for method in payment_methods %}
                    <option value="{{ method.stripe_payment_method_id }}" {% if method.is_default %}selected{% endif %}>
                        {{ method.card_brand }} **** {{ method.card_last4 }}
                        {% if method.is_default %}(Default){% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="button-main w-full">
                {% trans "Pay" %} ${{ invoice.amount_due|floatformat:2|intcomma }}
            </button>
        </form>
        {% else %}
        <div class="text-center py-4">
            <p class="caption1 text-secondary mb-4">{% trans "No payment methods on file" %}</p>
            <a href="{% url 'frontend:finance:payment-methods' %}" class="button-main">
                {% trans "Add Payment Method" %}
            </a>
        </div>
        {% endif %}
    </div>
    {% else %}
    <!-- Payment Confirmation -->
    <div class="p-6 rounded-lg bg-green bg-opacity-10 border border-green">
        <div class="flex">
            <span class="ph ph-check-circle text-green text-2xl mr-3"></span>
            <div>
                <h4 class="caption1 text-green font-semibold">{% trans "Payment Complete" %}</h4>
                <p class="caption1 text-green mt-1">
                    {% trans "This invoice was paid on" %} {{ invoice.paid_at|date:"M d, Y" }}
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Actions -->
    <div class="flex justify-between items-center">
        <a href="{% url 'frontend:finance:invoices' %}"
           class="caption1 text-secondary hover:text-title flex items-center gap-2">
            <span class="ph ph-arrow-left"></span>
            {% trans "Back to Invoices" %}
        </a>
        <a href="{% url 'frontend:finance:invoice-download' invoice_number=invoice.invoice_number %}"
           class="button-main -border flex items-center gap-2">
            <span class="ph ph-download-simple"></span>
            {% trans "Download PDF" %}
        </a>
    </div>
</div>
{% endblock %}
