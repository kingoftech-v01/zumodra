{% extends "base/freelanhub_dashboard_base.html" %}
{% load static i18n widget_tweaks %}

{% block title %}{% if job %}{% trans "Edit Job" %}{% else %}{% trans "Post New Job" %}{% endif %} - Zumodra{% endblock %}

{% block page_title %}
<div class="flex flex-wrap items-center justify-between gap-4">
    <h4 class="heading4 max-lg:mt-3">{% if job %}{% trans "Edit Job" %}{% else %}{% trans "Submit Job" %}{% endif %}</h4>
    <button class="button-main" type="submit" form="job-form">
        <span class="ph ph-check-circle text-xl"></span>
        {% trans "Save & Publish" %}
    </button>
</div>
{% endblock %}

{% block content %}
{% if request.tenant.tenant_type != 'company' %}
<div class="p-8 rounded-lg bg-yellow-50 border border-yellow-200">
    <div class="flex items-start gap-3">
        <span class="ph ph-warning text-2xl text-yellow-600"></span>
        <div>
            <p class="text-button text-yellow-800">
                {% trans "ATS features are only available for company tenants." %}
            </p>
            <a href="{% url 'tenants:tenant_settings' %}" class="caption1 line-before line-yellow-600 mt-2 inline-block">
                {% trans "Switch to company account" %}
            </a>
        </div>
    </div>
</div>
{% else %}
<form method="post"
      hx-post="{{ request.path }}"
      hx-target="#main-content"
      hx-swap="innerHTML"
      id="job-form">
    {% csrf_token %}

    <!-- Basic Information -->
    <div class="infomation p-8 mt-7.5 rounded-lg bg-white">
        <h5 class="heading5">{% trans "Basic Information" %}</h5>
        <div class="form grid sm:grid-cols-2 gap-5 mt-5">
            <!-- Job Title -->
            <div class="title col-span-full">
                <label for="id_title">{% trans "Job Title" %}: <span class="text-red">*</span></label>
                <input class="w-full h-12 px-4 mt-2 border-line rounded-lg {% if form.title.errors %}border-red{% endif %}"
                       id="id_title"
                       name="title"
                       type="text"
                       placeholder="{% trans 'e.g., Senior Software Engineer' %}"
                       value="{{ form.title.value|default:'' }}"
                       required />
                {% if form.title.errors %}
                <p class="caption1 text-red mt-1">{{ form.title.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Employment Type -->
            <div class="type">
                <label>{% trans "Employment Type" %}: <span class="text-red">*</span></label>
                <div class="select_block flex items-center w-full h-12 pr-10 pl-4 mt-2 border border-line rounded-lg">
                    <div class="select">
                        <span class="selected capitalize" data-title="{{ form.employment_type.value|default:'full_time' }}">
                            {% if form.employment_type.value == 'full_time' %}{% trans "Full-time" %}
                            {% elif form.employment_type.value == 'part_time' %}{% trans "Part-time" %}
                            {% elif form.employment_type.value == 'contract' %}{% trans "Contract" %}
                            {% else %}{% trans "Internship" %}{% endif %}
                        </span>
                        <ul class="list_option scrollbar_custom w-full max-h-[200px] bg-white">
                            <li class="capitalize" data-item="full_time">{% trans "Full-time" %}</li>
                            <li class="capitalize" data-item="part_time">{% trans "Part-time" %}</li>
                            <li class="capitalize" data-item="contract">{% trans "Contract" %}</li>
                            <li class="capitalize" data-item="internship">{% trans "Internship" %}</li>
                        </ul>
                    </div>
                    <span class="icon_down ph ph-caret-down right-3"></span>
                </div>
                <input type="hidden" name="employment_type" value="{{ form.employment_type.value|default:'full_time' }}" />
            </div>

            <!-- Experience Level -->
            <div class="level">
                <label>{% trans "Experience Level" %}: <span class="text-red">*</span></label>
                <div class="select_block flex items-center w-full h-12 pr-10 pl-4 mt-2 border border-line rounded-lg">
                    <div class="select">
                        <span class="selected capitalize" data-title="{{ form.experience_level.value|default:'mid' }}">
                            {% if form.experience_level.value == 'entry' %}{% trans "Entry Level" %}
                            {% elif form.experience_level.value == 'mid' %}{% trans "Mid Level" %}
                            {% elif form.experience_level.value == 'senior' %}{% trans "Senior Level" %}
                            {% else %}{% trans "Executive" %}{% endif %}
                        </span>
                        <ul class="list_option scrollbar_custom w-full max-h-[200px] bg-white">
                            <li class="capitalize" data-item="entry">{% trans "Entry Level" %}</li>
                            <li class="capitalize" data-item="mid">{% trans "Mid Level" %}</li>
                            <li class="capitalize" data-item="senior">{% trans "Senior Level" %}</li>
                            <li class="capitalize" data-item="executive">{% trans "Executive" %}</li>
                        </ul>
                    </div>
                    <span class="icon_down ph ph-caret-down right-3"></span>
                </div>
                <input type="hidden" name="experience_level" value="{{ form.experience_level.value|default:'mid' }}" />
            </div>

            <!-- Department -->
            <div class="department">
                <label for="id_department">{% trans "Department" %}:</label>
                <div class="select_block flex items-center w-full h-12 pr-10 pl-4 mt-2 border border-line rounded-lg">
                    <div class="select">
                        <span class="selected capitalize" data-title="{{ form.department.value|default:'' }}">
                            {% if form.department.value %}
                                {% for dept in departments %}
                                    {% if dept.id == form.department.value %}{{ dept.name }}{% endif %}
                                {% endfor %}
                            {% else %}{% trans "Select department" %}{% endif %}
                        </span>
                        <ul class="list_option scrollbar_custom w-full max-h-[200px] bg-white">
                            <li class="capitalize" data-item="">{% trans "Select department" %}</li>
                            {% for dept in departments %}
                            <li class="capitalize" data-item="{{ dept.id }}">{{ dept.name }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <span class="icon_down ph ph-caret-down right-3"></span>
                </div>
                <input type="hidden" name="department" id="id_department" value="{{ form.department.value|default:'' }}" />
            </div>

            <!-- Location -->
            <div class="location">
                <label for="id_location">{% trans "Location" %}:</label>
                <div class="select_block flex items-center w-full h-12 pr-10 pl-4 mt-2 border border-line rounded-lg">
                    <div class="select">
                        <span class="selected capitalize" data-title="{{ form.location.value|default:'' }}">
                            {% if form.location.value %}
                                {% for loc in locations %}
                                    {% if loc.id == form.location.value %}{{ loc.name }}{% endif %}
                                {% endfor %}
                            {% else %}{% trans "Select location" %}{% endif %}
                        </span>
                        <ul class="list_option scrollbar_custom w-full max-h-[200px] bg-white">
                            <li class="capitalize" data-item="">{% trans "Select location" %}</li>
                            {% for loc in locations %}
                            <li class="capitalize" data-item="{{ loc.id }}">{{ loc.name }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <span class="icon_down ph ph-caret-down right-3"></span>
                </div>
                <input type="hidden" name="location" id="id_location" value="{{ form.location.value|default:'' }}" />
            </div>

            <!-- Application Deadline -->
            <div class="deadline_date">
                <label for="id_closes_at">{% trans "Application Deadline" %}: <span class="text-red">*</span></label>
                <input class="w-full h-12 px-4 mt-2 border-line rounded-lg uppercase"
                       id="id_closes_at"
                       name="closes_at"
                       type="date"
                       value="{% if form.closes_at.value %}{{ form.closes_at.value|date:'Y-m-d' }}{% endif %}"
                       required />
            </div>

            <!-- Positions Available -->
            <div class="vacancy">
                <label for="id_positions_available">{% trans "Positions Available" %}: <span class="text-red">*</span></label>
                <input class="w-full h-12 px-4 mt-2 border-line rounded-lg"
                       id="id_positions_available"
                       name="positions_available"
                       type="number"
                       min="1"
                       value="{{ form.positions_available.value|default:1 }}"
                       required />
            </div>

            <!-- Salary Range -->
            <div class="min_salary">
                <label for="id_salary_min">{% trans "Min. Salary" %}:</label>
                <div class="flex items-center gap-2">
                    <span class="text-button text-secondary">$</span>
                    <input class="w-full h-12 px-4 mt-2 border-line rounded-lg"
                           id="id_salary_min"
                           name="salary_min"
                           type="number"
                           placeholder="50,000"
                           value="{{ form.salary_min.value|default:'' }}" />
                </div>
            </div>

            <div class="max_salary">
                <label for="id_salary_max">{% trans "Max. Salary" %}:</label>
                <div class="flex items-center gap-2">
                    <span class="text-button text-secondary">$</span>
                    <input class="w-full h-12 px-4 mt-2 border-line rounded-lg"
                           id="id_salary_max"
                           name="salary_max"
                           type="number"
                           placeholder="80,000"
                           value="{{ form.salary_max.value|default:'' }}" />
                </div>
            </div>

            <!-- Job Description -->
            <div class="desc col-span-full">
                <label for="id_description">{% trans "Job Description" %}: <span class="text-red">*</span></label>
                <textarea class="w-full min-h-[200px] px-4 py-3 mt-2 border-line rounded-lg"
                          id="id_description"
                          name="description"
                          placeholder="{% trans 'Describe the role, responsibilities, and what makes it exciting...' %}"
                          required>{{ form.description.value|default:'' }}</textarea>
                {% if form.description.errors %}
                <p class="caption1 text-red mt-1">{{ form.description.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Requirements -->
            <div class="requirements col-span-full">
                <label for="id_requirements">{% trans "Requirements" %}:</label>
                <textarea class="w-full min-h-[150px] px-4 py-3 mt-2 border-line rounded-lg"
                          id="id_requirements"
                          name="requirements"
                          placeholder="{% trans 'List the skills, qualifications, and experience required...' %}">{{ form.requirements.value|default:'' }}</textarea>
            </div>

            <!-- Benefits -->
            <div class="benefits col-span-full">
                <label for="id_benefits">{% trans "Benefits" %}:</label>
                <textarea class="w-full min-h-[120px] px-4 py-3 mt-2 border-line rounded-lg"
                          id="id_benefits"
                          name="benefits"
                          placeholder="{% trans 'Describe compensation, perks, and benefits...' %}">{{ form.benefits.value|default:'' }}</textarea>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex items-center justify-end gap-4 mt-7.5">
        <a href="{% url 'frontend:jobs:job_list' %}" class="button-main -border">
            <span class="ph ph-arrow-left text-xl"></span>
            {% trans "Cancel" %}
        </a>
        <button type="submit" name="action" value="draft" class="button-main -border">
            <span class="ph ph-floppy-disk text-xl"></span>
            {% trans "Save as Draft" %}
        </button>
        <button type="submit" name="action" value="publish" class="button-main">
            <span class="ph ph-paper-plane-right text-xl"></span>
            {% trans "Publish Job" %}
        </button>
    </div>
</form>
{% endif %}
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle custom select dropdowns
    document.querySelectorAll('.select_block').forEach(selectBlock => {
        const select = selectBlock.querySelector('.select');
        const selected = select.querySelector('.selected');
        const optionsList = select.querySelector('.list_option');
        const hiddenInput = selectBlock.parentElement.querySelector('input[type="hidden"]');

        selected.addEventListener('click', function(e) {
            e.stopPropagation();
            select.classList.toggle('open');
            optionsList.classList.toggle('hidden');
        });

        optionsList.querySelectorAll('li').forEach(option => {
            option.addEventListener('click', function(e) {
                e.stopPropagation();
                const value = this.getAttribute('data-item');
                const text = this.textContent.trim();

                selected.textContent = text;
                selected.setAttribute('data-title', value);

                if (hiddenInput) {
                    hiddenInput.value = value;
                }

                select.classList.remove('open');
                optionsList.classList.add('hidden');
            });
        });
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', function() {
        document.querySelectorAll('.select.open').forEach(select => {
            select.classList.remove('open');
            select.querySelector('.list_option').classList.add('hidden');
        });
    });
});
</script>
{% endblock %}
