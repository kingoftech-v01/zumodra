{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Export My Data" %}{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="zu-card shadow-sm">
                <div class="zu-card__header bg-primary text-white">
                    <h4 class="mb-0">
                        <svg class="w-5 h-5 inline-block me-2" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/>
                        </svg>
                        {% trans "Export My Data" %}
                    </h4>
                </div>
                <div class="zu-card__body">
                    <!-- GDPR Information -->
                    <div class="alert alert-info mb-4">
                        <h6 class="alert-heading">
                            <svg class="w-5 h-5 inline-block me-2" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z"/>
                            </svg>
                            {% trans "Your Right to Data Portability" %}
                        </h6>
                        <p class="mb-0">
                            {% blocktrans %}
                            Under GDPR Article 20, you have the right to receive your personal data
                            in a structured, commonly used and machine-readable format. This export
                            includes all data we hold about you.
                            {% endblocktrans %}
                        </p>
                    </div>

                    {% if existing_request %}
                    <!-- Existing Request Status -->
                    <div class="alert alert-warning mb-4">
                        <h6 class="alert-heading">
                            <svg class="w-5 h-5 inline-block me-2" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            {% trans "Export Request In Progress" %}
                        </h6>
                        <p class="mb-2">
                            {% blocktrans with status=existing_request.get_status_display date=existing_request.submitted_at %}
                            You have a pending export request submitted on {{ date }}.
                            Current status: {{ status }}
                            {% endblocktrans %}
                        </p>
                        <div class="progress" style="height: 25px;">
                            {% if existing_request.status == 'pending' %}
                            <div class="progress-bar bg-info" style="width: 25%">{% trans "Pending" %}</div>
                            {% elif existing_request.status == 'verified' %}
                            <div class="progress-bar bg-info" style="width: 50%">{% trans "Verified" %}</div>
                            {% elif existing_request.status == 'in_progress' %}
                            <div class="progress-bar bg-info" style="width: 75%">{% trans "Processing" %}</div>
                            {% endif %}
                        </div>
                        {% if existing_request.days_remaining %}
                        <small class="text-muted d-block mt-2">
                            {% blocktrans with days=existing_request.days_remaining %}
                            Expected completion within {{ days }} days.
                            {% endblocktrans %}
                        </small>
                        {% endif %}
                    </div>
                    {% else %}
                    <!-- Export Form -->
                    <form method="post" id="export-form">
                        {% csrf_token %}

                        <div class="mb-4">
                            <h6>{% trans "What's Included" %}</h6>
                            <p class="text-muted">
                                {% trans "Your data export will include:" %}
                            </p>
                            <ul class="list-group list-group-flush mb-3">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>
                                        <svg class="w-5 h-5 inline-block text-primary me-2" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"/>
                                        </svg>
                                        {% trans "Account Information" %}
                                    </span>
                                    <span class="badge bg-secondary">{% trans "Always included" %}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>
                                        <svg class="w-5 h-5 inline-block text-primary me-2" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 9h3.75M15 12h3.75M15 15h3.75M4.5 19.5h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5zm6-10.125a1.875 1.875 0 11-3.75 0 1.875 1.875 0 013.75 0zm1.294 6.336a6.721 6.721 0 01-3.17.789 6.721 6.721 0 01-3.168-.789 3.376 3.376 0 016.338 0z"/>
                                        </svg>
                                        {% trans "Profile Data" %}
                                    </span>
                                    <span class="badge bg-secondary">{% trans "Always included" %}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>
                                        <svg class="w-5 h-5 inline-block text-primary me-2" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/>
                                        </svg>
                                        {% trans "Applications & Documents" %}
                                    </span>
                                    <span class="badge bg-secondary">{% trans "If applicable" %}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>
                                        <svg class="w-5 h-5 inline-block text-primary me-2" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193-.34.027-.68.052-1.02.072v3.091l-3-3c-1.354 0-2.694-.055-4.02-.163a2.115 2.115 0 01-.825-.242m9.345-8.334a2.126 2.126 0 00-.476-.095 48.64 48.64 0 00-8.048 0c-1.131.094-1.976 1.057-1.976 2.192v4.286c0 .837.46 1.58 1.155 1.951m9.345-8.334V6.637c0-1.621-1.152-3.026-2.76-3.235A48.455 48.455 0 0011.25 3c-2.115 0-4.198.137-6.24.402-1.608.209-2.76 1.614-2.76 3.235v6.226c0 1.621 1.152 3.026 2.76 3.235.577.075 1.157.14 1.74.194V21l4.155-4.155"/>
                                        </svg>
                                        {% trans "Messages & Communications" %}
                                    </span>
                                    <span class="badge bg-secondary">{% trans "If applicable" %}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>
                                        <svg class="w-5 h-5 inline-block text-primary me-2" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z"/>
                                        </svg>
                                        {% trans "Privacy Consents" %}
                                    </span>
                                    <span class="badge bg-secondary">{% trans "Always included" %}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>
                                        <svg class="w-5 h-5 inline-block text-primary me-2" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        {% trans "Activity Logs" %}
                                    </span>
                                    <span class="badge bg-secondary">{% trans "If available" %}</span>
                                </li>
                            </ul>
                        </div>

                        <div class="zu-form-group mb-4">
                            <label class="zu-label">{% trans "Export Format" %}</label>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <div class="form-check custom-radio">
                                        <input class="zu-input" type="radio" name="format"
                                               id="format-json" value="json" checked>
                                        <label class="form-check-label w-100" for="format-json">
                                            <div class="zu-card border">
                                                <div class="zu-card__body text-center py-3">
                                                    <svg class="w-8 h-8 mx-auto text-primary mb-2" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75L22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3l-4.5 16.5"/>
                                                    </svg>
                                                    <div><strong>JSON</strong></div>
                                                    <small class="text-muted">{% trans "Machine-readable" %}</small>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check custom-radio">
                                        <input class="zu-input" type="radio" name="format"
                                               id="format-csv" value="csv">
                                        <label class="form-check-label w-100" for="format-csv">
                                            <div class="zu-card border">
                                                <div class="zu-card__body text-center py-3">
                                                    <svg class="w-8 h-8 mx-auto text-success mb-2" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 01-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-7.5A1.125 1.125 0 0112 18.375m9.75-12.75c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125m19.5 0v1.5c0 .621-.504 1.125-1.125 1.125M2.25 5.625v1.5c0 .621.504 1.125 1.125 1.125m0 0h17.25m-17.25 0h7.5c.621 0 1.125.504 1.125 1.125M3.375 8.25c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m17.25-3.75h-7.5c-.621 0-1.125.504-1.125 1.125m8.625-1.125c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125M12 10.875v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 10.875c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125M13.125 12h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125M20.625 12c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5M12 14.625v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 14.625c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125m0 1.5v-1.5m0 0c0-.621.504-1.125 1.125-1.125m0 0h7.5"/>
                                                    </svg>
                                                    <div><strong>CSV</strong></div>
                                                    <small class="text-muted">{% trans "Spreadsheet format" %}</small>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check custom-radio">
                                        <input class="zu-input" type="radio" name="format"
                                               id="format-xml" value="xml">
                                        <label class="form-check-label w-100" for="format-xml">
                                            <div class="zu-card border">
                                                <div class="zu-card__body text-center py-3">
                                                    <svg class="w-8 h-8 mx-auto text-warning mb-2" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/>
                                                    </svg>
                                                    <div><strong>XML</strong></div>
                                                    <small class="text-muted">{% trans "Structured data" %}</small>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="zu-form-group mb-4">
                            <div class="form-check">
                                <input class="zu-input" type="checkbox" id="immediate" name="immediate" value="true">
                                <label class="zu-label" for="immediate">
                                    {% trans "Generate export immediately" %}
                                    <small class="text-muted d-block">
                                        {% trans "For small datasets. Larger exports may be queued." %}
                                    </small>
                                </label>
                            </div>
                        </div>

                        <div class="d-flex gap-3">
                            <button type="submit" class="zu-btn zu-btn--primary">
                                <svg class="w-4 h-4 inline-block me-2" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/>
                                </svg>
                                {% trans "Request Export" %}
                            </button>
                            <a href="{% url 'privacy:dashboard' %}" class="zu-btn zu-btn--outline">
                                {% trans "Cancel" %}
                            </a>
                        </div>
                    </form>
                    {% endif %}

                    {% if last_export %}
                    <!-- Previous Export -->
                    <hr class="my-4">
                    <div class="mt-4">
                        <h6>{% trans "Your Last Export" %}</h6>
                        <div class="zu-card bg-light">
                            <div class="zu-card__body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ last_export.get_request_type_display }}</strong>
                                        <br>
                                        <small class="text-muted">
                                            {% trans "Completed" %} {{ last_export.completed_at|date:"F d, Y" }}
                                        </small>
                                    </div>
                                    {% if last_export.response_file %}
                                    <a href="{% url 'privacy:download_export' last_export.pk %}"
                                       class="zu-btn zu-btn--primary btn-sm">
                                        <svg class="w-4 h-4 inline-block me-1" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/>
                                        </svg>
                                        {% trans "Download" %}
                                    </a>
                                    {% else %}
                                    <span class="badge bg-secondary">{% trans "Expired" %}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <small class="text-muted d-block mt-2">
                            <svg class="w-4 h-4 inline-block me-1" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z"/>
                            </svg>
                            {% trans "Export files are available for 30 days after generation." %}
                        </small>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Security Notice -->
            <div class="alert alert-warning mt-4">
                <h6 class="alert-heading">
                    <svg class="w-5 h-5 inline-block me-2" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"/>
                    </svg>
                    {% trans "Security Notice" %}
                </h6>
                <ul class="mb-0">
                    <li>{% trans "The export will contain sensitive personal information." %}</li>
                    <li>{% trans "Keep the downloaded file secure and delete it when no longer needed." %}</li>
                    <li>{% trans "Do not share the download link with others." %}</li>
                    <li>{% trans "The export link expires after 30 days." %}</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<style>
.custom-radio .zu-input {
    position: absolute;
    opacity: 0;
}
.custom-radio .zu-card {
    cursor: pointer;
    transition: all 0.2s;
}
.custom-radio .zu-input:checked + .form-check-label .zu-card {
    border-color: #0d6efd !important;
    box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
}
.custom-radio .zu-card:hover {
    border-color: #0d6efd !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('export-form')?.addEventListener('submit', function(e) {
    const btn = this.querySelector('button[type="submit"]');
    btn.disabled = true;
    btn.innerHTML = '<svg class="w-4 h-4 inline-block me-2 animate-spin" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99"/></svg>{% trans "Processing..." %}';
});
</script>
{% endblock %}
