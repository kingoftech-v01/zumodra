import random
from decimal import Decimal
from datetime import timedelta
from django.utils import timezone
from django.utils.text import slugify
from django.contrib.auth import get_user_model
from django.contrib.gis.geos import Point

User = get_user_model()

# Import models
from ats.models import JobPosting, JobCategory, Pipeline, PipelineStage, Candidate, Application, Interview
from hr_core.models import Employee, TimeOffType

print('=== POPULATING DEMO DATA ===\n')

# Get admin
admin = User.objects.filter(is_superuser=True).first()
print(f'Using admin: {admin.email}\n')

# 1. Create job categories
print('1. Creating job categories...')
categories = []
for name in ['Engineering', 'Design', 'Marketing', 'Sales', 'Operations', 'HR', 'Finance', 'Legal']:
    cat, created = JobCategory.objects.get_or_create(
        name=name,
        defaults={'slug': slugify(name)}
    )
    categories.append(cat)
    if created:
        print(f'   Created: {name}')
print(f'   Total categories: {JobCategory.objects.count()}\n')

# 2. Setup pipeline
print('2. Setting up pipeline...')
pipeline = Pipeline.objects.filter(is_default=True).first()
if not pipeline:
    pipeline = Pipeline.objects.create(
        name='Default Pipeline',
        is_default=True,
        created_by=admin
    )
    print('   Created default pipeline')

    stages = [
        ('New', 'new', '#6B7280'),
        ('Screening', 'screening', '#3B82F6'),
        ('Phone Interview', 'interview', '#8B5CF6'),
        ('Technical Interview', 'interview', '#EC4899'),
        ('Final Interview', 'interview', '#F59E0B'),
        ('Offer', 'offer', '#10B981'),
        ('Hired', 'hired', '#059669'),
        ('Rejected', 'rejected', '#EF4444'),
    ]

    for i, (name, stage_type, color) in enumerate(stages):
        PipelineStage.objects.create(
            pipeline=pipeline,
            name=name,
            stage_type=stage_type,
            color=color,
            order=i
        )
    print(f'   Created {len(stages)} stages')
else:
    print(f'   Using existing pipeline: {pipeline.name}')
print(f'   Total stages: {PipelineStage.objects.count()}\n')

# 3. Time-off types
print('3. Creating time-off types...')
TimeOffType.objects.get_or_create(
    code='PTO',
    defaults={
        'name': 'Paid Time Off',
        'is_accrued': True,
        'accrual_rate': Decimal('0.77'),
        'max_balance': Decimal('20'),
    }
)
TimeOffType.objects.get_or_create(
    code='SICK',
    defaults={
        'name': 'Sick Leave',
        'is_accrued': True,
        'accrual_rate': Decimal('0.38'),
        'max_balance': Decimal('10'),
    }
)
print('   Created/verified time-off types\n')

# 4. Create jobs
print('4. Creating sample jobs...')
job_titles = [
    'Senior Software Engineer', 'Product Manager', 'UX Designer',
    'Data Scientist', 'DevOps Engineer', 'Marketing Manager',
    'Sales Representative', 'HR Coordinator', 'Full Stack Developer',
    'Frontend Developer', 'Backend Developer', 'QA Engineer',
    'Technical Writer', 'Customer Success Manager', 'Business Analyst',
    'Security Engineer', 'Mobile Developer', 'Cloud Architect',
    'Scrum Master', 'Technical Lead', 'Solutions Architect',
    'Site Reliability Engineer', 'Data Engineer', 'ML Engineer'
]

locations = [
    {'city': 'Montreal', 'country': 'Canada', 'lat': 45.5017, 'lon': -73.5673},
    {'city': 'Toronto', 'country': 'Canada', 'lat': 43.6532, 'lon': -79.3832},
    {'city': 'Vancouver', 'country': 'Canada', 'lat': 49.2827, 'lon': -123.1207},
    {'city': 'Ottawa', 'country': 'Canada', 'lat': 45.4215, 'lon': -75.6972},
    {'city': 'Calgary', 'country': 'Canada', 'lat': 51.0447, 'lon': -114.0719},
    {'city': 'Edmonton', 'country': 'Canada', 'lat': 53.5461, 'lon': -113.4938},
    {'city': 'New York', 'country': 'USA', 'lat': 40.7128, 'lon': -74.0060},
    {'city': 'San Francisco', 'country': 'USA', 'lat': 37.7749, 'lon': -122.4194},
]

existing_jobs = JobPosting.objects.count()
target_jobs = 20
jobs_to_create = max(0, target_jobs - existing_jobs)

jobs = list(JobPosting.objects.all())

if jobs_to_create > 0:
    for i in range(jobs_to_create):
        title = job_titles[i % len(job_titles)]
        location = locations[i % len(locations)]
        job_num = existing_jobs + i + 1

        job = JobPosting.objects.create(
            title=title,
            reference_code=f'JOB-{str(job_num).zfill(4)}',
            slug=slugify(f'{title}-{job_num}'),
            description=f'We are looking for a talented {title} to join our growing team.\n\nKey Responsibilities:\n- Design and implement innovative solutions\n- Collaborate with cross-functional teams\n- Mentor junior team members\n- Participate in code reviews',
            requirements='- 3+ years of relevant experience\n- Strong technical and communication skills\n- Bachelor degree in Computer Science or related field\n- Experience with modern development practices',
            benefits='- Competitive salary and equity\n- Comprehensive health insurance\n- 401k matching program\n- Flexible remote work options\n- Professional development budget',
            job_type=random.choice(['full_time', 'contract', 'full_time', 'full_time']),
            experience_level=random.choice(['mid', 'senior', 'lead']),
            remote_policy=random.choice(['remote', 'hybrid', 'on_site', 'hybrid']),
            location_city=location['city'],
            location_country=location['country'],
            location_coordinates=Point(location['lon'], location['lat'], srid=4326),
            salary_min=Decimal(random.randint(60, 100) * 1000),
            salary_max=Decimal(random.randint(100, 180) * 1000),
            show_salary=random.choice([True, False, True]),
            category=random.choice(categories),
            pipeline=pipeline,
            status='open',
            published_at=timezone.now() - timedelta(days=random.randint(1, 30)),
            created_by=admin,
            published_on_career_page=True,
            is_internal_only=False,
        )
        jobs.append(job)
    print(f'   Created {jobs_to_create} new jobs')
else:
    print(f'   Already have {existing_jobs} jobs')
print(f'   Total jobs: {JobPosting.objects.count()}\n')

# 5. Create candidates
print('5. Creating sample candidates...')
first_names = ['John', 'Jane', 'Mike', 'Sarah', 'David', 'Emily', 'Chris', 'Lisa', 'Alex', 'Kim', 'Ryan', 'Emma', 'Daniel', 'Olivia', 'James', 'Sophia', 'Robert', 'Ava', 'William', 'Mia']
last_names = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Martinez', 'Taylor', 'Anderson', 'Thomas', 'Jackson', 'White', 'Harris', 'Martin']
skills = ['Python', 'JavaScript', 'React', 'Django', 'AWS', 'Docker', 'SQL', 'Machine Learning', 'UI/UX', 'Agile', 'TypeScript', 'Node.js', 'Kubernetes', 'PostgreSQL', 'GraphQL']

existing_candidates = Candidate.objects.count()
target_candidates = 100
candidates_to_create = max(0, target_candidates - existing_candidates)

candidates = list(Candidate.objects.all())

if candidates_to_create > 0:
    for i in range(candidates_to_create):
        first_name = random.choice(first_names)
        last_name = random.choice(last_names)
        candidate_num = existing_candidates + i + 1

        candidate = Candidate.objects.create(
            first_name=first_name,
            last_name=last_name,
            email=f'{first_name.lower()}.{last_name.lower()}{candidate_num}@example.com',
            headline=f'{random.choice(job_titles)}',
            skills=random.sample(skills, k=random.randint(3, 7)),
            years_experience=random.randint(1, 15),
            city=random.choice(['Montreal', 'Toronto', 'Vancouver', 'Ottawa']),
            country='Canada',
            source=random.choice(['career_page', 'linkedin', 'referral', 'indeed', 'glassdoor']),
        )
        candidates.append(candidate)

        if jobs:
            num_applications = random.randint(1, min(3, len(jobs)))
            selected_jobs = random.sample(jobs, num_applications)

            for job in selected_jobs:
                Application.objects.create(
                    candidate=candidate,
                    job=job,
                    status=random.choice(['new', 'in_review', 'shortlisted', 'interviewing']),
                    ai_match_score=Decimal(random.randint(50, 98)),
                )
    print(f'   Created {candidates_to_create} new candidates')
else:
    print(f'   Already have {existing_candidates} candidates')
print(f'   Total candidates: {Candidate.objects.count()}')
print(f'   Total applications: {Application.objects.count()}\n')

# 6. Create employees
print('6. Creating employees...')
existing_employees = Employee.objects.count()
target_employees = 15
employees_to_create = max(0, target_employees - existing_employees)

if employees_to_create > 0:
    for i in range(employees_to_create):
        first_name = random.choice(first_names)
        last_name = random.choice(last_names)
        emp_num = existing_employees + i + 1
        email = f'{first_name.lower()}.{last_name.lower()}.emp{emp_num}@demo.example.com'

        if not User.objects.filter(email=email).exists():
            user = User.objects.create_user(
                email=email,
                password='employee123!',
                first_name=first_name,
                last_name=last_name,
            )

            Employee.objects.create(
                user=user,
                employee_id=f'EMP-{str(emp_num).zfill(4)}',
                job_title=random.choice(job_titles),
                hire_date=timezone.now().date() - timedelta(days=random.randint(30, 1000)),
                status='active',
                employment_type='full_time',
                base_salary=Decimal(random.randint(50, 150) * 1000),
                pto_balance=Decimal(random.randint(5, 20)),
            )
    print(f'   Created {employees_to_create} new employees')
else:
    print(f'   Already have {existing_employees} employees')
print(f'   Total employees: {Employee.objects.count()}\n')

# 7. Create interviews
print('7. Creating interviews...')
existing_interviews = Interview.objects.count()
target_interviews = 15
interviews_to_create = max(0, target_interviews - existing_interviews)

if interviews_to_create > 0 and candidates:
    applications = Application.objects.filter(
        status__in=['in_review', 'shortlisted', 'interviewing']
    )[:interviews_to_create]

    for app in applications:
        Interview.objects.create(
            application=app,
            title=f'{app.job.title} - Interview',
            interview_type='technical',
            scheduled_at=timezone.now() + timedelta(days=random.randint(1, 14)),
            duration_minutes=random.choice([30, 45, 60]),
            status=random.choice(['scheduled', 'completed']),
        )
    print(f'   Created {interviews_to_create} interviews')
else:
    print(f'   Already have {existing_interviews} interviews')
print(f'   Total interviews: {Interview.objects.count()}\n')

# Summary
print('=' * 50)
print('DEMO DATA SUMMARY')
print('=' * 50)
print(f'Job Categories: {JobCategory.objects.count()}')
print(f'Pipeline Stages: {PipelineStage.objects.count()}')
print(f'Job Postings: {JobPosting.objects.count()}')
print(f'Candidates: {Candidate.objects.count()}')
print(f'Applications: {Application.objects.count()}')
print(f'Employees: {Employee.objects.count()}')
print(f'Interviews: {Interview.objects.count()}')
print('=' * 50)
print('Demo data population complete!')
