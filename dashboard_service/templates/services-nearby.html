{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load leaflet_tags %}

{% block head_title %}Services - Zumodra{% endblock head_title %}

{% block extra_head %} 
    {% leaflet_js %}
    {% leaflet_css %}
{% endblock extra_head %}

{% block header %}
    {% include 'header2.html' %}
{% endblock header %}

{% block content %}
  
        <!-- List jobs -->
        <div class="jobs -half-map flex max-md:flex-col-reverse md:overflow-hidden md:w-screen md:h-screen sm:pt-20 pt-16">
            <div class="jobs_wrap relative md:w-1/2">
                <div class="jobs_inner lg:p-10 p-6">
                    <form id="address-form" style="margin-bottom: 1rem;">
                        <input type="text" id="address-input" placeholder="Enter address or postal code" style="width: 300px; padding: 0.3rem;">
                        <button type="submit">Find Address</button>
                    </form>
                    <div class="filter flex flex-wrap items-center justify-between gap-8 gap-y-3 relative w-full">
                        <button id="filter_btn" class="filter_btn inline-flex items-center gap-1.5 py-1.5 px-2.5 border border-line rounded-md duration-300 hover:bg-primary hover:text-white">
                            <span class="ph ph-sliders-horizontal text-xl"></span>
                            <span>Filters</span>
                        </button>
                        <ul class="list_layout flex items-center gap-1 2xl:absolute 2xl:left-1/2 2xl:-translate-x-1/2">
                            <li class="max-xl:hidden">
                                <button class="layout_btn cols_1 list"></button>
                            </li>
                            <li class="max-xl:hidden">
                                <button class="layout_btn cols_2 active"></button>
                            </li>
                        </ul>
                        <div class="select_filter flex items-center gap-3">
                            <span class="caption1">Sort by:</span>
                            <div class="select_block sm:pr-16 pr-10 pl-3 py-1 border border-line rounded">
                                <div class="select">
                                    <span class="selected caption1 capitalize" data-title="sort default">default</span>
                                    <ul class="list_option p-0 bg-white">
                                        <li class="capitalize" data-item="default">sort by (default)</li>
                                        <li class="capitalize" data-item="newest">newest</li>
                                        <li class="capitalize" data-item="oldest">oldest</li>
                                        <li class="capitalize" data-item="random">random</li>
                                    </ul>
                                </div>
                                <span class="icon_down ph ph-caret-down right-3"></span>
                            </div>
                        </div>
                    </div>
                    <div class="list_filtered flex flex-wrap items-center gap-3 w-full mt-5">
                        <span class="quantity pr-3 border-r border-line">1,200+ Results</span>
                        <div class="list flex flex-wrap items-center gap-3"></div>
                        <button class="clear_all_btn inline-flex items-center gap-1 py-1 px-2 border border-red text-red rounded-full duration-300 hover:bg-red hover:text-white">
                            <span class="ph ph-x text-sm"></span>
                            <span class="caption1">Clear All</span>
                        </button>
                    </div>
                    {% if providers %}
                    <ul class="list_layout_cols list_jobs grid 2xl:grid-cols-2 md:gap-7.5 gap-6 w-full md:mt-10 mt-7">
                        {% for provider in providers %}
                        <li class="jobs_item px-6 py-5 rounded-lg bg-white shadow-md duration-300 hover:shadow-xl">
                            <div class="jobs_info flex gap-4 w-full pb-4 border-b border-line">
                                <a href="{% url 'browse_service_detail' provider.uuid %}" class="overflow-hidden flex-shrink-0 w-15 h-15">
                                    <img src="{{ provider.image.url }}" alt="company/8" class="jobs_avatar w-full h-full object-cover" />
                                </a>
                                <div class="jobs_content flex items-center justify-between gap-2 w-full">
                                    <a href="jobs-detail1.html" class="jobs_detail flex flex-col gap-0.5 duration-300 hover:text-primary">
                                        <span class="jobs_company text-sm font-semibold text-primary">{{ provider.entity_name }}</span>
                                        <strong class="jobs_name text-title -style-1">Full Stack Developer</strong>
                                        <div class="flex flex-wrap items-center gap-5 gap-y-1">
                                            <div class="jobs_address -style-1 text-secondary">
                                                <span class="ph ph-map-pin text-lg"></span>
                                                <span class="address caption1 align-top">{{ provider.address }}</span>
                                            </div>
                                            <div class="jobs_date text-secondary">
                                                <span class="ph ph-calendar-blank text-lg"></span>
                                                <span class="date caption1 align-top">{{ provider.created_at }}</span>
                                            </div>
                                        </div>
                                    </a>
                                    <button class="add_wishlist_btn -relative -border">
                                        <span class="ph ph-heart text-xl"></span>
                                        <span class="ph-fill ph-heart text-xl"></span>
                                    </button>
                                </div>
                            </div>
                            <div class="jobs_more_info flex flex-wrap items-center justify-between gap-3 pt-4">
                                <div class="flex flex-wrap items-center gap-2.5">
                                    {% for skill in provider.skills.all %}
                                    <a href="jobs-default.html" class="jobs_tag caption1 tag bg-surface duration-300 hover:bg-primary hover:text-white">{{ skill.name }}</a>
                                    {% endfor %}
                                </div>
                                <div class="jobs_price">
                                    {% for star in provider.rating_avg %}
                                        <span class="ph ph-star text-lg"></span>
                                    {% endfor %}
                                    {% for star in (5 - provider.rating_avg) %}
                                    {% if is_verified %}
                                        <span class="price text-title">Verified</span>
                                    {% endif %}
                                    {% if is_mobile %}
                                        <span class="text-secondary">Mobile</span>
                                    {% else %}
                                        <span class="text-secondary">Fixed</span>
                                    {% endif %}
                                </div>
                            </div>
                        </li>
                    </ul>
                    {% endif %}
                </div>
                <ul class="list_pagination menu_tab flex items-center justify-center gap-2 md:absolute bottom-0 left-0 w-full h-[68px] bg-white" role="tablist">
                    <li role="presentation">
                        <a href="#" class="tab_btn -fill flex items-center justify-center w-10 h-10 rounded border border-line text-title duration-300 hover:border-black active" role="tab" aria-selected="true">1</a>
                    </li>
                    <li role="presentation">
                        <a href="#" class="tab_btn -fill flex items-center justify-center w-10 h-10 rounded border border-line text-title duration-300 hover:border-black" role="tab" aria-selected="false">2</a>
                    </li>
                    <li role="presentation">
                        <a href="#" class="tab_btn -fill flex items-center justify-center w-10 h-10 rounded border border-line text-title duration-300 hover:border-black" role="tab" aria-selected="false">3</a>
                    </li>
                    <li role="presentation">
                        <a href="#" class="tab_btn -fill flex items-center justify-center w-10 h-10 rounded border border-line text-title duration-300 hover:border-black" role="tab" aria-selected="false">></a>
                    </li>
                </ul>
            </div>
            <div class="map_bg md:w-1/2 md:h-full w-full h-[400px]">
                <div id="map" class="w-full h-full"></div>
            </div>
        </div>   
        <!-- Toastify -->
        <div class="toastify">
            <div class="toastify_inner flex items-center gap-3 relative max-w-[90vw] p-3 rounded-l-lg bg-white">
                <div class="toastify_logo flex-shrink-0 w-15 h-15">
                    <img src="./assets/images/company/13.png" alt="company/13" class="w-full h-full object-cover" />
                </div>
                <div class="toastify_message pr-11">
                    <h6 class="text-title">Tony Nguyen found a job on the map</h6>
                    <a href="jobs-top-map.html" class="inline-block mt-1 text-sm font-bold uppercase text-primary line-before">Click here to find jobs by MAP</a>
                </div>
            </div>
            <button class="toastify_close_btn flex items-center justify-center absolute top-3 right-3 w-6 h-6 rounded-full bg-surface duration-300 hover:bg-black hover:text-white">
                <span class="ph-bold ph-x"></span>
            </button>
        </div>
          

{% endblock content %}

{% block js %}

<script>
    // Initialize map centered roughly on the center of the world (fallback)
    var map = L.map('map').setView([0, 0], 6);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    
    // Custom icons
    var userIcon = L.icon({
        iconUrl: '{% static "assets/images/map/user-marker-icon.png" %}',
        iconSize: [30, 40],
        iconAnchor: [15, 40],
        popupAnchor: [0, -40]
    });
    
    var serviceIcon = L.icon({
        iconUrl: '{% static "assets/images/map/service-marker-icon.png" %}',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34]
    });
    
    // Marker layer groups
    var userMarkerLayer = L.layerGroup().addTo(map);
    var serviceMarkersLayer = L.layerGroup().addTo(map);
    
    // Add service provider markers
    {% for provider in service_providers %}
        {% if provider.location %}
            L.marker([{{ provider.location.y }}, {{ provider.location.x }}], {icon: serviceIcon})
                .addTo(serviceMarkersLayer)
                .bindPopup("<b>{{ provider.user.username }}</b><br>{{ provider.address }}<br>Rating: {{ provider.rating_avg }}");
        {% endif %}
    {% endfor %}
    
    // Function to add or move user marker
    // function showUserLocation(lat, lng, popupText) {
    //     userMarkerLayer.clearLayers();
    //     var marker = L.marker([lat, lng], {icon: userIcon}).addTo(userMarkerLayer);
    //     marker.bindPopup(popupText).openPopup();
    //     map.setView([lat, lng], 13);
    // }
    
    // Function to show the user location marker and accuracy circle
    function showUserLocation(lat, lng, accuracy) {
        userMarkerLayer.clearLayers();
        var latlng = L.latLng(lat, lng);

        var marker = L.marker(latlng, {icon: userIcon}).addTo(userMarkerLayer);
        marker.bindPopup("You are within " + accuracy + " meters from this point").openPopup();

        L.circle(latlng, {radius: accuracy}).addTo(userMarkerLayer);

        map.setView(latlng, 13);
    }

    // 
    // Use the native geolocation API for better accuracy
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                showUserLocation(position.coords.latitude, position.coords.longitude, position.coords.accuracy);
            },
            function(error) {
                console.error("Error obtaining location: ", error.message);
                alert("Location access denied or unavailable.");
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    } else {
        alert("Geolocation is not supported by this browser.");
    }

    // Detect user location with Leaflet
    map.locate({setView: false, maxZoom: 16});
    map.on('locationfound', function(e) {
        showUserLocation(e.latitude, e.longitude, "You are here");
    });
    map.on('locationerror', function() {
        console.log("Location access denied or unavailable.");
    });
    
    // Handle address submission (example assumes you have an input with id="address-input")
    document.getElementById('address-form').addEventListener('submit', function(event) {
        event.preventDefault();
        var address = document.getElementById('address-input').value;
        if (!address) return;
    
        // Use Nominatim API for geocoding the address to lat/lng
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    var lat = parseFloat(data[0].lat);
                    var lon = parseFloat(data[0].lon);
                    showUserLocation(lat, lon, "Search Result: " + data[0].display_name);
                } else {
                    alert("Address not found.");
                }
            })
            .catch(() => alert("Geocoding service error."));
    });
    </script>
    
{% endblock js %}


<!-- // Initialize WebSocket
const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
const wsUrl = `${protocol}://${window.location.host}/ws/location/`;
const locationSocket = new WebSocket(wsUrl);

// When connection opens
locationSocket.onopen = function(event) {
    // Initial request or triggered by location changes
    sendLocationUpdate();
};

// When receiving data
locationSocket.onmessage = function(event) {
    const data = JSON.parse(event.data);
    if (data.providers) {
        updateProviderList(data.providers);
        updateMapMarkers(data.providers);
    }
};

// Function to send current or new location and filters
function sendLocationUpdate() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            // Gather filters from UI
            const skill = document.getElementById('skill-filter').value || null;
            const category = document.getElementById('category-filter').value || null;
            const min_hourly = document.getElementById('min-hourly').value || null;
            const max_hourly = document.getElementById('max-hourly').value || null;

            locationSocket.send(JSON.stringify({
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                radius: 10, // Or from a slider/filter UI
                skill: skill,
                category: category,
                min_hourly: min_hourly,
                max_hourly: max_hourly,
            }));
        });
    }
}

// Update list and map dynamically
function updateProviderList(providers) {
    // Your logic to update the HTML provider list here
}

function updateMapMarkers(providers) {
    // Your logic to update Leaflet map markers here
}

// Optionally re-send on filter change:
document.getElementById('filter-form').addEventListener('change', sendLocationUpdate); -->
