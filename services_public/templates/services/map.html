{% extends 'base_public.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<style>
.custom-marker-wrapper { background: transparent; border: none; }
.custom-marker { display: flex; align-items: center; justify-content: center; }
.leaflet-popup-content { margin: 0; padding: 12px; }
.leaflet-popup-content-wrapper { padding: 0; }
</style>
{% endblock %}

{% block page_content %}
<div class="service_map flex max-md:flex-col-reverse md:overflow-hidden md:w-screen md:h-screen sm:pt-20 pt-16">
    <div class="service_wrap relative md:w-1/2 md:overflow-y-auto">
        <div class="service_inner lg:p-10 p-6">
            <div class="filter flex flex-wrap items-center justify-between gap-8 gap-y-3 w-full">
                <button id="filter_btn" class="filter_btn inline-flex items-center gap-1.5 py-1.5 px-2.5 border border-line rounded-md duration-300 hover:bg-primary hover:text-white">
                    <span class="ph ph-sliders-horizontal text-xl"></span>
                    <span>Filters</span>
                </button>
                <div class="select_filter flex items-center gap-3">
                    <span class="caption1">Sort by:</span>
                    <form method="get" action="" class="inline">
                        {% for key, value in request.GET.items %}{% if key != 'sort' %}<input type="hidden" name="{{ key }}" value="{{ value }}" />{% endif %}{% endfor %}
                        <select name="sort" onchange="this.form.submit()" class="sm:pr-16 pr-10 pl-3 py-1 border border-line rounded caption1">
                            <option value="default" {% if active_filters.sort == 'default' %}selected{% endif %}>Featured</option>
                            <option value="rating" {% if active_filters.sort == 'rating' %}selected{% endif %}>Highest Rated</option>
                            <option value="newest" {% if active_filters.sort == 'newest' %}selected{% endif %}>Newest</option>
                        </select>
                    </form>
                </div>
            </div>
            <div class="list_filtered flex flex-wrap items-center gap-3 w-full mt-5">
                <span class="quantity pr-3 border-r border-line">{{ total_count }}+ Result{% if total_count != 1 %}s{% endif %}</span>
            </div>
            <ul class="list_service grid grid-cols-1 md:gap-7.5 gap-5 md:mt-10 mt-7">
                {% for service in services %}
                <li class="service_item p-6 rounded-lg bg-white shadow-md hover:shadow-xl duration-300" data-service-uuid="{{ service.service_uuid }}">
                    <div class="flex justify-between gap-3 pb-4 border-b border-line">
                        <div class="service_content">
                            <a href="{% url 'services_public:service_detail' service.service_uuid %}" class="heading6 duration-300 hover:underline">{{ service.name }}</a>
                            <div class="flex flex-wrap items-center gap-3 mt-3">
                                <div class="flex items-center gap-2">
                                    {% if service.provider_avatar_url %}<img src="{{ service.provider_avatar_url }}" alt="{{ service.provider_name }}" class="w-8 h-8 rounded-full" />{% else %}<img src="{% static 'assets/images/avatar/default-avatar.webp' %}" alt="{{ service.provider_name }}" class="w-8 h-8 rounded-full" />{% endif %}
                                    <span class="caption1 text-secondary">{{ service.provider_name }}</span>
                                </div>
                                {% if service.location_city %}<div class="flex items-center gap-1"><span class="ph ph-map-pin text-xl text-secondary"></span><span class="caption1 text-secondary">{{ service.location_city }}{% if service.location_state %}, {{ service.location_state }}{% endif %}</span></div>{% endif %}
                            </div>
                            <div class="flex items-center gap-3 mt-3">
                                <div class="flex items-center gap-1"><span class="ph-fill ph-star text-yellow"></span><strong>{{ service.rating_avg|default:"0.0" }}</strong><span class="caption1 text-secondary">({{ service.total_reviews|default:0 }})</span></div>
                                {% if service.is_featured %}<span class="tag caption2 bg-primary text-white">Featured</span>{% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center justify-between pt-4">
                        <div><span class="text-secondary">From </span><span class="text-title">${{ service.price|default:"0" }}</span></div>
                        <a href="{% url 'services_public:service_detail' service.service_uuid %}" class="button-main -border -small">View</a>
                    </div>
                </li>
                {% empty %}
                <li class="text-center py-20">
                    <div class="flex flex-col items-center gap-4">
                        <span class="ph ph-map-pin text-6xl text-secondary opacity-40"></span>
                        <h4 class="heading4 text-secondary">No Services Found</h4>
                        <a href="{% url 'services_public:service_list' %}" class="button-main mt-4">Browse All</a>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <div class="map_wrap relative md:w-1/2 h-screen">
        <div id="service-map" class="w-full h-full"></div>
        <div class="map_controls absolute top-4 right-4 bg-white rounded-lg shadow-lg p-3 flex flex-col gap-2 z-[500]">
            <button id="locate-me" class="flex items-center justify-center w-10 h-10 border border-line rounded-md duration-300 hover:bg-primary hover:text-white"><span class="ph ph-crosshair text-xl"></span></button>
        </div>
    </div>
</div>
{% include 'includes/modals/modal-services-list.html' %}
{% endblock %}

{% block extra_js %}
<!-- Leaflet.js for Maps -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<!-- WebSocket and Map Components -->
<script src="{% static 'services_public/js/websocket-client.js' %}"></script>
<script src="{% static 'services_public/js/filter-handler.js' %}"></script>
<script src="{% static 'services_public/js/map-viewer.js' %}"></script>
<script src="{% static 'services_public/js/main.js' %}"></script>

<!-- Map Data (GeoJSON) -->
<script id="map-data" type="application/json">
{
    "center": [{{ map_center.lat }}, {{ map_center.lng }}],
    "zoom": {{ map_zoom }},
    "geojson": {{ geojson|safe }}
}
</script>

<script>
// Initialize map with fallback
document.addEventListener('DOMContentLoaded', function() {
    console.log('[Map] Page loaded, initializing...');

    const map = L.map('service-map').setView([{{ map_center.lat }}, {{ map_center.lng }}], {{ map_zoom }});
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19, attribution: 'Â© OpenStreetMap'}).addTo(map);
    const geojson = {{ geojson|safe }};
    const markers = L.markerClusterGroup({maxClusterRadius: 50});
    const serviceIcon = L.divIcon({html: '<div class="custom-marker"><span class="ph-fill ph-map-pin text-primary text-3xl"></span></div>', className: 'custom-marker-wrapper', iconSize: [30, 30], iconAnchor: [15, 30]});

    if (geojson && geojson.features) {
        geojson.features.forEach(feature => {
            const coords = feature.geometry.coordinates;
            const props = feature.properties;
            const marker = L.marker([coords[1], coords[0]], { icon: serviceIcon });
            const popupContent = `<div class="max-w-xs"><h6 class="font-semibold">${props.name}</h6><div class="flex items-center gap-2 mt-2"><span class="ph-fill ph-star text-yellow"></span><strong>${props.rating_avg || '0.0'}</strong><span>(${props.total_reviews || 0})</span></div><div class="flex justify-between mt-3"><span class="font-bold text-primary">$${props.price || '0'}</span><a href="/browse-services/${props.service_uuid}/" class="button-main -small -border">View</a></div></div>`;
            marker.bindPopup(popupContent, { maxWidth: 300 });
            marker.on('click', function() {
                const card = document.querySelector(`[data-service-id="${props.service_uuid}"]`);
                if (card) {
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    card.classList.add('ring-2', 'ring-primary');
                    setTimeout(() => card.classList.remove('ring-2', 'ring-primary'), 2000);
                }
            });
            markers.addLayer(marker);
        });
        map.addLayer(markers);
        if (geojson.features.length > 0) map.fitBounds(markers.getBounds(), { padding: [50, 50] });
    }

    document.getElementById('locate-me').addEventListener('click', function() {
        if ('geolocation' in navigator) {
            navigator.geolocation.getCurrentPosition(function(position) {
                map.setView([position.coords.latitude, position.coords.longitude], 13);
                L.marker([position.coords.latitude, position.coords.longitude]).addTo(map).bindPopup('You are here').openPopup();
            });
        }
    });
});
</script>
{% endblock %}
