version: '3.9'

# CI-optimized Docker Compose configuration
# Lightweight setup for testing and continuous integration

networks:
  ci-network:
    driver: bridge

services:
  postgres-test:
    image: postgres:13-alpine
    container_name: greaterwms_postgres_test
    environment:
      POSTGRES_DB: greaterwms_test
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_HOST_AUTH_METHOD: trust
    ports:
      - "5432:5432"
    networks:
      - ci-network
    # Optimized for CI speed
    command: >
      postgres
        -c shared_buffers=256MB
        -c max_connections=100
        -c work_mem=4MB
        -c maintenance_work_mem=64MB
        -c effective_cache_size=1GB
        -c checkpoint_completion_target=0.9
        -c wal_buffers=16MB
        -c default_statistics_target=100
        -c random_page_cost=1.1
        -c effective_io_concurrency=200
        -c synchronous_commit=off
        -c fsync=off
        -c full_page_writes=off
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s

  redis-test:
    image: redis:7-alpine
    container_name: greaterwms_redis_test
    ports:
      - "6379:6379"
    networks:
      - ci-network
    # Optimized for CI
    command: >
      redis-server
        --maxmemory 128mb
        --maxmemory-policy allkeys-lru
        --save ""
        --appendonly no
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  backend-test:
    build:
      context: .
      target: backend-dev
      dockerfile: Dockerfile.ci
    container_name: greaterwms_backend_test
    environment:
      - DJANGO_SETTINGS_MODULE=greaterwms.settings.ci
      - DATABASE_URL=postgres://postgres:postgres@postgres-test:5432/greaterwms_test
      - REDIS_URL=redis://redis-test:6379/0
      - DEBUG=False
      - SECRET_KEY=ci-test-secret-key-not-for-production
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
    depends_on:
      postgres-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    networks:
      - ci-network
    # No volumes for CI - use image only
    command: >
      sh -c "
        python manage.py check --deploy &&
        python manage.py migrate --noinput &&
        python manage.py collectstatic --noinput &&
        python manage.py test --verbosity=2
      "

  frontend-test:
    build:
      context: ./templates
      dockerfile: Dockerfile.ci
    container_name: greaterwms_frontend_test
    environment:
      - NODE_ENV=test
      - CI=true
    # No volumes for CI - use image only
    command: >
      sh -c "
        npm ci --only=production &&
        npm run lint &&
        npm test &&
        npm run build
      "
    networks:
      - ci-network

# Volume definitions for CI (minimal)
volumes:
  postgres_test_data:
    driver: local
  redis_test_data:
    driver: local