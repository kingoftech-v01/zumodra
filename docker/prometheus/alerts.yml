# =============================================================================
# Prometheus Alert Rules for Zumodra
# =============================================================================

groups:
  # ===========================================================================
  # Infrastructure Alerts
  # ===========================================================================
  - name: infrastructure
    rules:
      # High CPU usage
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage is above 80% on {{ $labels.instance }} for 5 minutes."

      # High memory usage
      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage detected"
          description: "Memory usage is above 85% on {{ $labels.instance }}."

      # Disk space running low
      - alert: DiskSpaceLow
        expr: (node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"} / node_filesystem_size_bytes{fstype!~"tmpfs|overlay"}) * 100 < 15
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Disk space running low"
          description: "Less than 15% disk space remaining on {{ $labels.instance }}."

      # Disk space critical
      - alert: DiskSpaceCritical
        expr: (node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"} / node_filesystem_size_bytes{fstype!~"tmpfs|overlay"}) * 100 < 5
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Disk space critically low"
          description: "Less than 5% disk space remaining on {{ $labels.instance }}."

  # ===========================================================================
  # Application Alerts
  # ===========================================================================
  - name: application
    rules:
      # Django service down
      - alert: DjangoServiceDown
        expr: up{job="django"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Django service is down"
          description: "Django application on {{ $labels.instance }} is unreachable."

      # High request latency
      - alert: HighRequestLatency
        expr: histogram_quantile(0.95, sum(rate(django_http_requests_latency_seconds_bucket[5m])) by (le, job)) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High request latency detected"
          description: "95th percentile request latency is above 2 seconds."

      # High error rate
      - alert: HighErrorRate
        expr: sum(rate(django_http_responses_total_by_status_total{status=~"5.."}[5m])) / sum(rate(django_http_responses_total_by_status_total[5m])) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High error rate detected"
          description: "More than 5% of requests are returning 5xx errors."

      # Critical error rate
      - alert: CriticalErrorRate
        expr: sum(rate(django_http_responses_total_by_status_total{status=~"5.."}[5m])) / sum(rate(django_http_responses_total_by_status_total[5m])) > 0.15
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Critical error rate detected"
          description: "More than 15% of requests are returning 5xx errors."

  # ===========================================================================
  # Database Alerts
  # ===========================================================================
  - name: database
    rules:
      # PostgreSQL down
      - alert: PostgreSQLDown
        expr: pg_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL is down"
          description: "PostgreSQL database is unreachable."

      # High database connections
      - alert: HighDatabaseConnections
        expr: pg_stat_activity_count / pg_settings_max_connections > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High database connection usage"
          description: "PostgreSQL connection usage is above 80%."

      # Database replication lag
      - alert: DatabaseReplicationLag
        expr: pg_replication_lag > 30
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Database replication lag detected"
          description: "PostgreSQL replication lag is above 30 seconds."

      # Slow queries
      - alert: SlowQueries
        expr: rate(pg_stat_statements_seconds_total[5m]) / rate(pg_stat_statements_calls_total[5m]) > 1
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Slow database queries detected"
          description: "Average query time is above 1 second."

  # ===========================================================================
  # Redis Alerts
  # ===========================================================================
  - name: redis
    rules:
      # Redis down
      - alert: RedisDown
        expr: redis_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Redis is down"
          description: "Redis server is unreachable."

      # Redis memory usage high
      - alert: RedisMemoryHigh
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Redis memory usage high"
          description: "Redis memory usage is above 85%."

      # Redis connected clients high
      - alert: RedisConnectionsHigh
        expr: redis_connected_clients > 500
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High Redis connections"
          description: "Redis has more than 500 connected clients."

  # ===========================================================================
  # Celery Alerts
  # ===========================================================================
  - name: celery
    rules:
      # Celery workers down
      - alert: CeleryWorkersDown
        expr: count(up{job="celery"}) < 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Celery workers reduced"
          description: "Less than 10 Celery workers are running."

      # Celery queue backlog
      - alert: CeleryQueueBacklog
        expr: rabbitmq_queue_messages_ready > 1000
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Celery queue backlog detected"
          description: "More than 1000 messages pending in Celery queues."

  # ===========================================================================
  # Nginx Alerts
  # ===========================================================================
  - name: nginx
    rules:
      # Nginx down
      - alert: NginxDown
        expr: nginx_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Nginx is down"
          description: "Nginx reverse proxy is unreachable."

      # High 5xx rate from Nginx
      - alert: NginxHigh5xxRate
        expr: rate(nginx_http_requests_total{status=~"5.."}[5m]) / rate(nginx_http_requests_total[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High 5xx error rate in Nginx"
          description: "Nginx is returning more than 5% 5xx errors."

  # ===========================================================================
  # SSL Certificate Alerts
  # ===========================================================================
  - name: ssl
    rules:
      # SSL certificate expiring soon
      - alert: SSLCertificateExpiringSoon
        expr: probe_ssl_earliest_cert_expiry - time() < 86400 * 14
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "SSL certificate expiring soon"
          description: "SSL certificate expires in less than 14 days."

      # SSL certificate expiring very soon
      - alert: SSLCertificateExpiringVerySoon
        expr: probe_ssl_earliest_cert_expiry - time() < 86400 * 7
        for: 1h
        labels:
          severity: critical
        annotations:
          summary: "SSL certificate expiring very soon"
          description: "SSL certificate expires in less than 7 days."
