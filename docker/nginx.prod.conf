# =============================================================================
# Zumodra Production Nginx Configuration
# =============================================================================
# Optimized for 500K+ concurrent connections with TLS 1.3
# Security hardened with HSTS, rate limiting, and strict CSP
# =============================================================================

# Run as non-root user
user nginx;

# Auto-detect CPU cores for optimal worker processes
worker_processes auto;

# Increase worker connections limit
worker_rlimit_nofile 65535;

# Error logging
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

# Event processing configuration
events {
    # Maximum connections per worker (500K / workers)
    worker_connections 65535;

    # Use efficient event model (Linux)
    use epoll;

    # Accept multiple connections at once
    multi_accept on;
}

http {
    # ==========================================================================
    # Basic Settings
    # ==========================================================================
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Charset
    charset utf-8;

    # Hide nginx version
    server_tokens off;

    # ==========================================================================
    # Logging Configuration
    # ==========================================================================
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    log_format detailed '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for" '
                        'rt=$request_time uct="$upstream_connect_time" '
                        'uht="$upstream_header_time" urt="$upstream_response_time" '
                        'cs=$upstream_cache_status';

    log_format json escape=json '{'
                    '"time_local":"$time_local",'
                    '"remote_addr":"$remote_addr",'
                    '"remote_user":"$remote_user",'
                    '"request":"$request",'
                    '"status":"$status",'
                    '"body_bytes_sent":"$body_bytes_sent",'
                    '"request_time":"$request_time",'
                    '"http_referrer":"$http_referer",'
                    '"http_user_agent":"$http_user_agent",'
                    '"http_x_forwarded_for":"$http_x_forwarded_for"'
                    '}';

    access_log /var/log/nginx/access.log detailed buffer=512k flush=1m;

    # ==========================================================================
    # Performance Optimizations
    # ==========================================================================
    # Sendfile for static file serving
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;

    # Connection timeouts
    keepalive_timeout 65;
    keepalive_requests 1000;

    # Client settings
    client_body_timeout 60s;
    client_header_timeout 60s;
    send_timeout 60s;

    # Buffer sizes
    client_body_buffer_size 128k;
    client_max_body_size 100M;
    client_header_buffer_size 4k;
    large_client_header_buffers 4 32k;

    # Hash sizes
    types_hash_max_size 2048;
    server_names_hash_bucket_size 128;

    # Open file cache
    open_file_cache max=10000 inactive=20s;
    open_file_cache_valid 30s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;

    # ==========================================================================
    # Gzip Compression
    # ==========================================================================
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 1024;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/x-javascript
        application/xml
        application/xml+rss
        application/atom+xml
        application/vnd.ms-fontobject
        application/x-font-ttf
        application/x-font-opentype
        application/x-font-truetype
        font/eot
        font/opentype
        font/otf
        font/truetype
        image/svg+xml
        image/vnd.microsoft.icon
        image/x-icon;

    # Brotli compression (if module available)
    # brotli on;
    # brotli_comp_level 6;
    # brotli_types text/plain text/css application/json application/javascript text/xml application/xml image/svg+xml;

    # ==========================================================================
    # SSL/TLS Configuration (TLS 1.3 Only)
    # ==========================================================================
    ssl_protocols TLSv1.3;
    ssl_prefer_server_ciphers off;

    # TLS 1.3 ciphersuites (modern only)
    ssl_ciphers TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256;

    # ECDH curve
    ssl_ecdh_curve X25519:secp384r1;

    # SSL session configuration
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_session_tickets off;

    # OCSP Stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    resolver 8.8.8.8 8.8.4.4 1.1.1.1 1.0.0.1 valid=300s;
    resolver_timeout 5s;

    # DH parameters (4096-bit)
    ssl_dhparam /etc/nginx/ssl/dhparam.pem;

    # ==========================================================================
    # Security Headers (Global)
    # ==========================================================================
    # HSTS with preload (2 years)
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

    # Prevent clickjacking
    add_header X-Frame-Options "SAMEORIGIN" always;

    # Prevent MIME type sniffing
    add_header X-Content-Type-Options "nosniff" always;

    # XSS Protection
    add_header X-XSS-Protection "1; mode=block" always;

    # Referrer Policy
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Permissions Policy
    add_header Permissions-Policy "accelerometer=(), camera=(), geolocation=(self), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()" always;

    # Content Security Policy
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://unpkg.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net; connect-src 'self' wss: https:; frame-ancestors 'self'; base-uri 'self'; form-action 'self';" always;

    # ==========================================================================
    # Rate Limiting Zones
    # ==========================================================================
    # General API rate limiting (10 requests per minute per IP)
    limit_req_zone $binary_remote_addr zone=api_limit:20m rate=10r/m;

    # Login rate limiting (5 requests per minute per IP)
    limit_req_zone $binary_remote_addr zone=login_limit:10m rate=5r/m;

    # General page rate limiting (60 requests per minute per IP)
    limit_req_zone $binary_remote_addr zone=general_limit:20m rate=60r/m;

    # WebSocket connection limiting
    limit_req_zone $binary_remote_addr zone=ws_limit:10m rate=30r/m;

    # Connection limiting
    limit_conn_zone $binary_remote_addr zone=conn_limit:20m;

    # Rate limit response code
    limit_req_status 429;
    limit_conn_status 429;

    # ==========================================================================
    # Upstream Backend Servers
    # ==========================================================================
    upstream django {
        # Load balancing with least connections
        least_conn;

        # Django web servers (10 replicas)
        server web:8000 max_fails=3 fail_timeout=30s weight=1;

        # Keep connections alive to upstream
        keepalive 64;
        keepalive_timeout 60s;
        keepalive_requests 1000;
    }

    upstream websocket {
        # WebSocket servers need IP hash for session persistence
        ip_hash;

        server web:8000;

        keepalive 32;
    }

    # ==========================================================================
    # Proxy Cache Configuration
    # ==========================================================================
    proxy_cache_path /var/cache/nginx/api
                     levels=1:2
                     keys_zone=api_cache:100m
                     max_size=1g
                     inactive=60m
                     use_temp_path=off;

    proxy_cache_path /var/cache/nginx/static
                     levels=1:2
                     keys_zone=static_cache:100m
                     max_size=5g
                     inactive=7d
                     use_temp_path=off;

    # ==========================================================================
    # Geo-blocking (Optional - uncomment to enable)
    # ==========================================================================
    # geo $blocked_country {
    #     default 0;
    #     # Add blocked country IP ranges here
    # }

    # ==========================================================================
    # Map for WebSocket upgrade
    # ==========================================================================
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    # ==========================================================================
    # Include site configurations
    # ==========================================================================
    include /etc/nginx/conf.d/*.conf;
}
